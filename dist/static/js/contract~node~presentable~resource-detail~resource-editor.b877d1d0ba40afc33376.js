(window.webpackJsonp=window.webpackJsonp||[]).push([["contract~node~presentable~resource-detail~resource-editor"],{"59r6":function(t,e,n){"use strict";n.d(e,"b",function(){return r}),n.d(e,"c",function(){return o});var a=n("3eXy"),s=(n("snnE"),n("LvDl"),n("C2Lv"));function r(t){return a.ResourceService.get(t).then(function(t){return 0===t.data.errcode?t.getData():Promise.reject(t.data)})}var o=function(t){return r(t).then(function(t){return t})};e.a={loadDetail:r,loadResources:function(t){return s.a.get("/v1/resources/list",{params:{resourceIds:t.join(",")}}).then(function(t){return t.getData()})},onloadResourceDetail:o}},"6ifa":function(t,e,n){"use strict";n.r(e),n.d(e,"CONTRACT_STATUS",function(){return a}),n.d(e,"CONTRACT_STATUS_TIPS",function(){return s}),n.d(e,"CONTRACT_STATUS_COLORS",function(){return r});var a={uncreated:-1,initial:1,running:2,activated:3,userTerminated:4,sysTerminated:5,terminated:6},s={"-1":"未创建合同",1:"未开始执行",2:"执行中",3:"系统锁住",4:"生效中",5:"",6:"合同已终止"},r={"-1":{type:"danger",desc:"未创建合同"},1:{type:"warning",desc:"未开始执行"},2:{type:"warning",desc:"执行中"},3:{type:"info",desc:"系统终止"},4:{type:"success",desc:"生效中"},5:{type:"info",desc:""},6:{type:"info",desc:"合同已终止"}}},"9K4q":function(t,e,n){"use strict";var a=n("Trkb");n.n(a).a},BcFS:function(t,e,n){"use strict";var a=n("lOto");n.n(a).a},ExDf:function(t,e,n){"use strict";n("bTlt");var a,s={name:"transaction-event",data:function(){return{options:[],fromAccountId:"",password:"",tipMsg:"",order:{},showError:!1}},mounted:function(){var t=this;this.$services.accounts.get().then(function(e){t.options=e.data.data}),this.queryOrder().then(this.checkOrderStatus.bind(this))},computed:{unitType:function(){return this.params.params[0].substr(0,4)}},props:["contractDetail","params"],methods:{payResultHandler:function(t){switch(t.status){case 1:this.$message.success("支付进行中，稍后查询支付结果");break;case 2:this.$message.success("支付成功");break;case 3:this.$message.success("支付失败");break;default:this.$message.info("未知的支付状态")}},doneHandler:function(t){this.order&&(t={shouldUpdate:!0}),this.$emit("close",t)},checkOrderStatus:function(t){if(t){var e;switch(this.order=t,t.status){case 1:e="支付进行中";break;case 2:e="已支付成功";break;case 3:e="支付失败"}this.tipMsg=e}},queryOrder:function(){return this.$services.orderInfo.get({params:{targetId:this.contractDetail.contractId}}).then(function(t){return t.getData()})},pay:function(){var t=this;this.$services.pay.post({targetId:this.contractDetail.contractId,orderType:1,fromAccountId:this.fromAccountId,toAccountId:this.params.params[0],amount:this.params.params[1],password:this.password}).then(function(e){0===e.data.errcode?(t.showError=!1,t.payResultHandler(e.data.data),t.doneHandler({shouldUpdate:!0,data:e.data.data})):(t.showError=!0,t.$message.error(e.data.msg))}).catch(this.$error.showErrorMessage)}}},r=(n("Kj8m"),n("KHd+")),o=Object(r.a)(s,function(){var t=this,e=t.$createElement,n=t._self._c||e;return n("div",{staticClass:"transaction-wrap"},[t.tipMsg?n("el-alert",{attrs:{title:t.tipMsg,type:"warning"}}):t._e(),t._v(" "),t.showError?n("el-alert",{attrs:{title:"",type:"warning"}},[t._v("\n      未设置支付密码，"),n("a",{staticStyle:{color:"#409EFF"},attrs:{href:"//www.freelog.com/pages/account/security.html",target:"_blank"}},[t._v("去设置")])]):t._e(),t._v(" "),n("el-form",{staticClass:"small-el-form",attrs:{"label-position":"left","label-width":"80px",model:t.contractDetail}},[n("el-form-item",{attrs:{label:"contractId"}},[t._v("\n        "+t._s(t.contractDetail.contractId)+"\n      ")]),t._v(" "),n("el-form-item",{attrs:{label:"甲方"}},[t._v("\n        "+t._s(t.contractDetail.partyOne)+"\n      ")]),t._v(" "),n("el-form-item",{attrs:{label:"乙方"}},[t._v("\n        "+t._s(t.contractDetail.partyTwo)+"\n      ")]),t._v(" "),n("el-form-item",{attrs:{label:"转入账号"}},[t._v("\n        "+t._s(t.params.params[0])+"\n      ")]),t._v(" "),n("el-form-item",{attrs:{label:"转账金额"}},[t._v("\n        "+t._s(t._f("humanizeCurrency")(t.params.params[1]))+" "+t._s(t.unitType)+"\n      ")]),t._v(" "),n("el-form-item",{attrs:{label:"转出账号"}},[n("el-select",{attrs:{size:"small",placeholder:"请选择"},model:{value:t.fromAccountId,callback:function(e){t.fromAccountId=e},expression:"fromAccountId"}},t._l(t.options,function(t){return n("el-option",{key:t.accountId,attrs:{label:t.accountId,value:t.accountId}})})),t._v(" "),n("el-tooltip",{attrs:{placement:"top"}},[n("div",{attrs:{slot:"content"},slot:"content"},[n("p",[n("a",{staticStyle:{color:"white"},attrs:{href:"//www.freelog.com/pages/account/create.html",target:"_blank"}},[t._v("没有账号？去添加一个")])])]),t._v(" "),n("i",{staticClass:"el-icon-question"})])],1),t._v(" "),n("el-form-item",{attrs:{label:"支付密码"}},[n("el-input",{staticStyle:{"max-width":"300px"},attrs:{type:"password",size:"small",placeholder:"请输入支付密码"},model:{value:t.password,callback:function(e){t.password=e},expression:"password"}})],1),t._v(" "),n("el-form-item",[n("el-button",{on:{click:t.doneHandler}},[t._v("取 消")]),t._v(" "),n("el-button",{attrs:{type:"primary",disabled:1==t.order.status||2==t.order.status},on:{click:t.pay}},[t._v("确 定")])],1)],1)],1)},[],!1,null,null,null).exports,c={name:"license-event",data:function(){return{accepted:!1,licenses:[]}},mounted:function(){this.loadLicenses()},props:["contractDetail","params"],methods:{loadLicenses:function(){var t=this,e=this.params.params.map(function(e){return t.loadLicenseContent(e)});Promise.all(e).then(function(e){t.licenses=e}).catch(this.$error.showErrorMessage)},loadLicenseContent:function(t){var e=this;return this.$axios.get("/v1/auths/resource/".concat(t,".data")).then(function(t){if(15!=t.getData().errcode)return t.getData();e.$message.warning("协议格式不正确，请联系合约作者。")})},signHandler:function(){var t=this;this.$services.signingLicenses.post({contractId:this.contractDetail.contractId,eventId:this.params.eventId,licenseIds:this.params.params,nodeId:this.$route.params.nodeId}).then(function(e){0===e.data.errcode?(t.$message.success("执行成功"),t.doneHandler(!0)):t.$message.error(e.data.msg)})},doneHandler:function(t){this.$emit("close",{shouldUpdate:t})}}},i=(n("q4R6"),Object(r.a)(c,function(){var t=this,e=t.$createElement,n=t._self._c||e;return n("div",{staticClass:"license-event-wrap"},[n("el-form",{staticClass:"small-el-form",attrs:{"label-position":"left","label-width":"80px",model:t.contractDetail}},[n("el-form-item",{attrs:{label:"协议"}},[n("div",{staticClass:"license-window"},t._l(t.licenses,function(e){return n("pre",{staticClass:"license-format"},[t._v("          "+t._s(e)+"\n        ")])}))]),t._v(" "),n("el-form-item",[n("el-checkbox",{staticClass:"accept-license",model:{value:t.accepted,callback:function(e){t.accepted=e},expression:"accepted"}},[t._v("接受协议")])],1),t._v(" "),n("div",{staticClass:"center"},[n("el-button",{on:{click:t.doneHandler}},[t._v("取 消")]),t._v(" "),n("el-button",{attrs:{type:"primary",disabled:!t.accepted},on:{click:t.signHandler}},[t._v("确 定")])],1)],1)],1)},[],!1,null,null,null).exports),l=(n("6ifa"),n("zQX5")),u={name:"contract-detail-info",data:function(){return{detail:null,refreshing:!1}},props:{data:{type:Object,default:function(){return{statusInfo:{}}}},shouldShowSegment:{type:Boolean,default:function(){return!0}},labelWidth:{type:Number,default:function(){return 100}},showRefreshing:{type:Boolean,default:function(){return!1}}},mounted:function(){this.render()},watch:{data:"render"},methods:{refreshHandler:function(){var t=this;this.refreshing=!0,this.$emit("refresh",{done:function(){t.refreshing=!1}})},render:function(){this.detail=l.a.format(this.data)}}},d=(n("BcFS"),Object(r.a)(u,function(){var t=this,e=t.$createElement,n=t._self._c||e;return t.detail?n("el-form",{staticClass:"small-el-form",attrs:{"label-position":"right","label-width":t.labelWidth+"px"}},[n("el-form-item",{attrs:{label:"合同ID"}},[t._v("\n    "+t._s(t.detail.contractId)+"\n  ")]),t._v(" "),n("el-form-item",{attrs:{label:"创建日期"}},[n("span",[t._v(t._s(t._f("fmtDate")(t.detail.createDate)))])]),t._v(" "),t.detail.statusInfo?n("el-form-item",{attrs:{label:"合同状态"}},[n("el-tag",{attrs:{type:t.detail.statusInfo.type}},[t._v("\n      "+t._s(t.detail.statusInfo.desc)+"\n    ")]),t._v(" "),t.showRefreshing&&t.detail.status<4?n("i",{staticClass:"el-icon-refresh",class:{"el-icon-loading":t.refreshing},on:{click:t.refreshHandler}}):t._e()],1):t._e(),t._v(" "),n("el-form-item",{attrs:{label:"状态机状态"}},[n("el-tag",{attrs:{type:4===t.detail.status?"success":"warning"}},[t._v("\n      "+t._s(t.detail.contractClause.currentFsmState)+"\n    ")])],1),t._v(" "),n("el-form-item",{attrs:{label:"甲方"}},[t.detail.partyOneInfo?n("span",[t._v(t._s(t.detail.partyOneInfo.nickname))]):n("span",[t._v(t._s(t.detail.partyOne))])]),t._v(" "),n("el-form-item",{attrs:{label:"乙方"}},[t.detail.partyTwoInfo?n("span",[t._v(t._s(t.detail.partyTwoInfo.nodeName))]):n("span",[t._v(t._s(t.detail.partyTwo))])]),t._v(" "),t.detail.policySegment&&t.shouldShowSegment?n("el-form-item",{attrs:{label:"合同详情"}},[n("br"),t._v(" "),n("pre",{staticStyle:{overflow:"auto"}},[t._v(t._s(t.detail._policyText))])]):t._e(),t._v(" "),t._t("default")],2):t._e()},[],!1,null,"014f9df9",null).exports),f=n("7JPV");function h(t,e,n){return e in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}var m={name:"contract-detail",props:{contract:{type:Object,required:!0}},data:function(){return{}},computed:{contractId:function(){return this.contract.contractId},fsmStates:function(){return this.contract.contractClause.fsmStates},currentFsmState:function(){return this.contract.contractClause.currentFsmState},policyText:function(){return this.contract.contractClause.policyText},contractDetail:function(){return Object(f.highlightPolicy)(this.policyText)}},methods:(a={toggleClass:function(t,e){var n=t.className;-1!==n.indexOf(e)?t.className=n.replace(e,""):t.className="".concat(n," ").concat(e)},highlightCurrentState:function(){if("none"!==this.currentFsmState){var t=this.$el.querySelector(".bp-s-".concat(this.currentFsmState));this.toggleClass(t,"active")}},handlerProxy:function(t){var e=t.target.dataset,n=e.handler;if(this[n]){var a=this.getStateTransitionData(e.transition);if(null!==a){var s=a.code,r=a.params,o=a.eventId;this[n](s,r,o)}}},getStateTransitionData:function(t){return this.fsmStates[this.currentFsmState]?this.fsmStates[this.currentFsmState].transition[t]:null},signingEvent:function(t,e,n){this.$axios.post("/v1/contracts/events/signingLicenses",{contractId:this.contractId,eventId:n,licenseIds:parmas.licenseResourceId,nodeId:window.__auth_info__.__auth_node_id__}).then(function(t){200===t.status?0===t.data.errcode?console.log("license sign success!"):console.log("license sign fail! error: ".concat(t.data.msg)):console.log("/v1/contracts/events/signingLicenses 请求失败！")})},cycleEndEvent:function(t,e,n){},transactionEvent:function(t,e,n){},settlementEvent:function(t,e,n){},viewCountEvent:function(t,e,n){},recontractCountEvent:function(t,e,n){},presentCountEvent:function(t,e,n){},escrowExceedAmount:function(t,e,n){console.log("run escrowExceedAmount - code, params, eventId --",t,e,n)},escrowConfiscated:function(t,e,n){this.$axios("/v1/contracts/events/escrowConfiscated",{contractId:this.contractId,eventId:n,toAccountId:e}).then(function(t){200===t.status?0===t.data.errcode?console.log("Escrow has been confiscated success!"):console.log("Escrow has been confiscated fail! error: ".concat(t.data.msg)):console.log("/v1/contracts/events/escrowConfiscated 请求失败！")})}},h(a,"cycleEndEvent",function(t){}),h(a,"customEvent",function(t){}),a),mounted:function(){this.highlightCurrentState()},updated:function(){this.highlightCurrentState()}},p=(n("9K4q"),Object(r.a)(m,function(){var t=this.$createElement;return(this._self._c||t)("div",{staticClass:"contract-detail-content-wrapper",domProps:{innerHTML:this._s(this.contractDetail)},on:{click:this.handlerProxy}})},[],!1,null,null,null).exports),v=n("59r6"),g={transaction:{type:"transaction-event",title:"支付"},signing:{type:"license-event",title:"签署"}},_={name:"presentable-contract-detail",data:function(){return{eventComponent:"",dialogTitle:"",showEventExecDialog:!1,loading:!0,contractDetail:{},resourceDetail:{},account:"",options:[],password:"",selectedContractEvent:""}},components:{TransactionEvent:o,LicenseEvent:i,ContractDetailInfo:d,ContractContent:p},props:{contractId:String},watch:{contractId:"initContractDetail"},mounted:function(){this.initContractDetail()},methods:{initContractDetail:function(){var t=this;this.contractId?this.loadContractDetail(this.contractId).then(function(e){Object(v.c)(e.resourceId).then(function(e){t.resourceDetail=e}),t.contractDetail=l.a.format(e),t.loading=!1}):this.loading=!1},handleCloseDialog:function(t){this.closeDialogHandler(),t()},closeDialogHandler:function(t){var e=this;t&&t.shouldUpdate&&setTimeout(function(){e.updateContractDetail()},500),this.eventComponent="",this.dialogTitle="",this.$refs.eventDialog.hide()},formatData:function(){var t=Object.assign({},this.contractDetail);t=l.a.format(t)},loadContractDetail:function(t){return this.$services.contract.get(t||{}).then(function(t){return t.getData()}).catch(this.$error.showErrorMessage)},updateContractDetail:function(t){var e=this;this.loadContractDetail(this.contractDetail.contractId).then(function(n){Object.assign(e.contractDetail,n),e.formatData(),t&&t.done&&t.done()})},executeContractHandler:function(t){var e=g[t.type];this.selectedContractEvent=t,this.eventComponent=e.type,this.dialogTitle=e.title,this.showEventExecDialog=!0},activateContractHandler:function(t){var e=this;this.$axios.get("/v1/contracts/initial",{params:{contractIds:t.contractId}}).then(function(n){0===n.data.errcode?(e.$message.success("成功激活合同"),e.loadContractDetail(t.contractId).then(function(n){Object.assign(t,n),e.$emit("update",l.a.format(t))})):e.$error.showErrorMessage(n.data.msg)})}}},b=(n("zilE"),Object(r.a)(_,function(){var t=this,e=t.$createElement,n=t._self._c||e;return t.contractDetail.contractId?n("section",[n("el-dialog",{ref:"eventDialog",attrs:{title:t.dialogTitle,visible:t.showEventExecDialog,"before-close":t.handleCloseDialog,center:!0,width:"40%"},on:{"update:visible":function(e){t.showEventExecDialog=e}}},[n(t.eventComponent,{tag:"component",attrs:{contractDetail:t.contractDetail,params:t.selectedContractEvent},on:{close:t.closeDialogHandler}})],1),t._v(" "),n("div",{directives:[{name:"loading",rawName:"v-loading",value:t.loading,expression:"loading"}]},[n("el-form",{attrs:{"label-width":"120px"}},[n("el-form-item",{staticStyle:{"margin-bottom":"0"},attrs:{label:"资源名称"}},[t._v("\n        "+t._s(t.resourceDetail.resourceName)+"\n      ")]),t._v(" "),n("el-form-item",{staticStyle:{"margin-bottom":"0"},attrs:{label:"资源类型"}},[t._v("\n        "+t._s(t.resourceDetail.resourceType)+"\n      ")])],1),t._v(" "),n("contract-detail-info",{attrs:{data:t.contractDetail,showRefreshing:!0,labelWidth:120,shouldShowSegment:!1},on:{refresh:t.updateContractDetail}},[n("el-form-item",{attrs:{label:"合同详情"}},[n("contract-content",{attrs:{contract:t.contractDetail},on:{execute:t.executeContractHandler}})],1),t._v(" "),1===t.contractDetail.status?n("el-form-item",{staticClass:"flex-grid",attrs:{label:"激活合同"}},[n("el-button",{attrs:{size:"small"},on:{click:function(e){t.activateContractHandler(t.contractDetail)}}},[t._v("立即激活\n        ")])],1):t._e()],1)],1)],1):t._e()},[],!1,null,"10d3dc1e",null));e.a=b.exports},JwYz:function(t,e,n){},Kj8m:function(t,e,n){"use strict";var a=n("JwYz");n.n(a).a},LFMb:function(t,e,n){},Trkb:function(t,e,n){},XflS:function(t,e,n){},lOto:function(t,e,n){},q4R6:function(t,e,n){"use strict";var a=n("XflS");n.n(a).a},zQX5:function(t,e,n){"use strict";var a=n("NKFe"),s=n.n(a),r=(n("1O/z"),n("tpTV"),n("6ifa"));n("oCYn");e.a={format:function(t){if(t)return t.policySegment&&(t._policyText=s.a.beautify(t.policySegment.policyText).trim(),t.forUsers=t.policySegment.users.map(function(t){return{users:t.users.join("、"),type:t.userType}})),t.statusInfo=r.CONTRACT_STATUS_COLORS[t.status],t}}},zilE:function(t,e,n){"use strict";var a=n("LFMb");n.n(a).a}}]);