(window.webpackJsonp=window.webpackJsonp||[]).push([["presentable"],{"+cXM":function(e,t,n){"use strict";n.r(t);var s=n("8SHQ"),a=n("b4GV"),i={name:"freelog-tags",data:function(){return{tags:[],inputVisible:!1,inputValue:""}},props:{value:{type:Array,default:function(){return[]}},actionText:{type:String,default:function(){return"New Tag"}}},watch:{value:function(e){this.setCurrentValue(e)}},mounted:function(){this.setCurrentValue(this.value)},methods:{setCurrentValue:function(e){this.tags=e},handleClose:function(e){this.tags.splice(this.tags.indexOf(e),1),console.log(this.tags),this.$emit("input",this.tags)},showInput:function(){var e=this;this.inputVisible=!0,this.$nextTick(function(t){e.$refs.saveTagInput.$refs.input.focus()})},handleInputConfirm:function(){var e=this.inputValue;e&&(this.tags.push(e),this.$emit("input",this.tags)),this.inputVisible=!1,this.inputValue=""}}},r=(n("kFP0"),n("KHd+")),c=Object(r.a)(i,function(){var e=this,t=e.$createElement,n=e._self._c||t;return n("div",[e._l(e.tags,function(t){return n("el-tag",{key:t,staticClass:"user-defined-tag",attrs:{closable:"","disable-transitions":!1},on:{close:function(n){e.handleClose(t)}}},[e._v("\n    "+e._s(t)+"\n  ")])}),e._v(" "),e.inputVisible?n("el-input",{ref:"saveTagInput",staticClass:"input-new-tag",attrs:{size:"small"},on:{blur:e.handleInputConfirm},nativeOn:{keyup:function(t){return"button"in t||!e._k(t.keyCode,"enter",13,t.key,"Enter")?e.handleInputConfirm(t):null}},model:{value:e.inputValue,callback:function(t){e.inputValue=t},expression:"inputValue"}}):n("el-button",{staticClass:"button-new-tag",attrs:{size:"small"},on:{click:e.showInput}},[n("i",{staticClass:"el-icon-plus"}),e._v(" "+e._s(e.actionText))])],2)},[],!1,null,"03cf44fc",null).exports,o=(n("mL9P"),n("LvDl"),s.a.PRESENTABLE_STATUS_TIPS),l={name:"presentable-editor",data:function(){return{rules:{name:[{required:!0,message:"请输入presentable name",trigger:"blur"}]},inputData:{presentableName:"",policy:[],userDefinedTags:[]},userDefinedTags:[]}},components:{TagsEditor:c,PresentablePolicy:a.a},props:{data:{type:Object}},watch:{data:function(){this.initView()}},computed:{isValidPolicy:function(){return this.inputData.policy.some(function(e){return 1===e.status})}},mounted:function(){this.initView()},methods:{initView:function(){this.data.presentableId&&(Object.assign(this.inputData,this.data),this.userDefinedTags=this.inputData.userDefinedTags)},validatePolicyHandler:function(e){e.done&&this.$message.success("校验通过")},changePolicyHandler:function(){},formatPresentable:function(e){e._statusInfo=o[e.status],e.isReady=3==(3&e.status)},savePresentableHandler:function(){var e=this,t=this.$refs.editor.getChangeData(),n={presentableName:this.inputData.presentableName};n.userDefinedTags=this.userDefinedTags,Object.keys(t).length&&(n.policies=t),this.$services.presentables.put(this.data.presentableId,n).then(function(t){if(0===t.data.errcode){var n=t.getData();delete n.resourceInfo,Object.assign(e.inputData,n),e.formatPresentable(e.inputData),e.$emit("onSaveEnd",n),e.$message.success("更新成功")}else e.$message.error(t.data.msg||"更新失败")}).catch(this.$error.showErrorMessage)}}},u=(n("n8+z"),Object(r.a)(l,function(){var e=this,t=e.$createElement,n=e._self._c||t;return n("section",{staticClass:"presentable-input-info"},[n("div",{staticClass:"presentable-input-item"},[e._m(0),e._v(" "),n("div",{staticClass:"p-input-item-content"},[n("el-input",{staticClass:"presentable-name-input",attrs:{placeholder:"输入节点资源名称"},model:{value:e.inputData.presentableName,callback:function(t){e.$set(e.inputData,"presentableName",t)},expression:"inputData.presentableName"}})],1)]),e._v(" "),n("div",{staticClass:"presentable-input-item"},[e._m(1),e._v(" "),n("div",{staticClass:"p-input-item-content"},[n("tags-editor",{attrs:{actionText:"新标签"},model:{value:e.userDefinedTags,callback:function(t){e.userDefinedTags=t},expression:"userDefinedTags"}})],1)]),e._v(" "),n("div",{staticClass:"presentable-input-item"},[n("p",{staticClass:"p-input-item-title",class:[e.isValidPolicy?"active-status-2":"active-status-0"]},[n("i",{staticClass:"dot"}),e._v("节点资源授权策略")]),e._v(" "),n("presentable-policy",{ref:"editor",attrs:{showValidate:!1},on:{change:e.changePolicyHandler},model:{value:e.inputData,callback:function(t){e.inputData=t},expression:"inputData"}})],1),e._v(" "),n("div",{staticClass:"presentable-input-ft"},[n("el-button",{staticClass:"p-input-btn",on:{click:e.savePresentableHandler}},[e._v("保存")])],1)])},[function(){var e=this.$createElement,t=this._self._c||e;return t("p",{staticClass:"p-input-item-title active-status-0"},[t("i",{staticClass:"dot",staticStyle:{visibility:"hidden"}}),this._v("节点资源名称")])},function(){var e=this.$createElement,t=this._self._c||e;return t("p",{staticClass:"p-input-item-title"},[t("i",{staticClass:"dot",staticStyle:{visibility:"hidden"}}),this._v("节点资源标签")])}],!1,null,"0bfc1d14",null).exports),d=n("qTA6"),h=n("59r6"),p=n("aNms");function f(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var b={name:"presentable-detail",data:function(){return{showBindWidgetDialog:!1,loading:!1,bindWidget:{},presentableDetail:{},activeTabName:"resource",nodeId:this.$route.params.nodeId,editPresentable:{name:"",policyText:"",userDefinedTags:[]},presentableData:{resourceInfo:{}}}},props:{detail:{type:Object}},components:{PresentablePolicy:a.a,FreelogTags:c,PresentableEditor:u,ResourceIntroInfo:d.a},computed:{},watch:{"detail.presentableId":function(){this.initView()}},mounted:function(){this.initView()},methods:{initView:function(){var e=this;this.detail.resourceId&&(this.presentableData=this.detail,h.a.onloadResourceDetail(this.detail.resourceId).then(function(t){e.presentableData.resourceInfo=function(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{},s=Object.keys(n);"function"==typeof Object.getOwnPropertySymbols&&(s=s.concat(Object.getOwnPropertySymbols(n).filter(function(e){return Object.getOwnPropertyDescriptor(n,e).enumerable}))),s.forEach(function(t){f(e,t,n[t])})}return e}({},t)}),this.loadPresentableScheme())},loadPresentableScheme:function(){var e=this,t=this.getPresentableContract();t&&p.a.onloadSchemeDetail(t.authSchemeId).then(function(n){if(n){for(var s=0;s<n.policy.length;s++){var a=n.policy[s];if(a.segmentId===t.policySegmentId){n.selectedPolicy=a;break}}e.$set(e.presentableData,"scheme",n)}})},getPresentableContract:function(){var e=this.presentableData.contracts||[];if(e.length)for(var t,n=0;n<e.length;n++)if((t=e[n]).resourceId===this.presentableData.resourceId)return t;return null},gotoSchemeDetailHandler:function(){this.$router.push({path:"/node/".concat(this.$route.params.nodeId,"/presentable/").concat(this.detail.presentableId,"/scheme_detail"),query:{resourceId:this.detail.resourceId}})},savePresentableEnd:function(e){this.$emit("update",e)}}},m=(n("G2YG"),n("NPCl"),Object(r.a)(b,function(){var e=this,t=e.$createElement,n=e._self._c||t;return n("section",{staticClass:"presentable-detail-wrapper"},[n("resource-intro-info",{staticClass:"res-intro-info",attrs:{resource:e.presentableData.resourceInfo}},[n("div",{staticClass:"presentable-auth-intro",class:{"active-status-2":e.presentableData.scheme},on:{click:e.gotoSchemeDetailHandler}},[n("i",{staticClass:"dot"}),e._v(" "),e.presentableData.scheme&&e.presentableData.scheme.selectedPolicy?n("span",[e._v("\n        "+e._s(e.presentableData.scheme.authSchemeName)+"/"+e._s(e.presentableData.scheme.selectedPolicy.policyName)+"\n      ")]):n("span",[e._v("未选择授权方案及授权策略")]),e._v(" "),n("i",{staticClass:"el-icon-edit"})])]),e._v(" "),n("presentable-editor",{attrs:{data:e.presentableData},on:{onSaveEnd:e.savePresentableEnd}})],1)},[],!1,null,"9d68f8de",null).exports),v={name:"fl-switch",data:function(){return{checked:!1}},props:{width:{type:String,default:function(){return"50px"}},value:{type:[Boolean,String,Number],default:!1},activeText:String,inactiveText:String},watch:{},mounted:function(){this.checked=this.value},computed:{},methods:{switchHandler:function(){this.checked=!this.checked,this.$emit("input",this.checked),this.$emit("change",this.checked)}}},g=(n("0T9k"),Object(r.a)(v,function(){var e=this,t=e.$createElement,n=e._self._c||t;return n("div",{staticClass:"fl-switch-wrap"},[n("div",{staticClass:"switch-container",class:[e.checked?"active-switch":"inactive-switch"],on:{click:e.switchHandler}},[n("i",{staticClass:"switch-mesh"}),e._v(" "),n("span",{staticClass:"switch-label"},[e._v(e._s(e.checked?e.activeText:e.inactiveText))])])])},[],!1,null,"7ac8082e",null).exports),P=n("H2zm"),I=s.a.PRESENTABLE_STATUS_TIPS,S={name:"presentables",data:function(){return{showSearchResource:!1,presentableList:[],currentPresentable:{index:-1,detail:{}}}},components:{PresentableDetail:m,FreelogSwitch:g,SearchResource:P.a},watch:{$route:function(){this.initView(this.$route.params.nodeId)}},mounted:function(){this.initView(this.$route.params.nodeId)},methods:{queryHandler:function(){this.$message.warning("待开发")},initView:function(e){var t=this;e?(Object.assign(this.currentPresentable,{index:-1,detail:{}}),this.loadPresentables({nodeId:e,isOnline:2}).then(this.formatHandler.bind(this)).then(function(e){t.presentableList=e})):this.$message.error("缺失节点ID参数")},formatHandler:function(e){var t=this;return e&&e.length?(e.forEach(function(e){t.resolvePresentable(e)}),e):[]},resolvePresentable:function(e){e.isOnlineChecked=!!e.isOnline,e._statusInfo=I[e.status],e.isReady=3==(3&e.status)},loadPresentables:function(e){return this.$services.presentables.get({params:e}).then(function(e){return e.getData()}).catch(this.$error.showErrorMessage)},changePresentableHandler:function(e,t){this.currentPresentable.index=t,this.currentPresentable.detail=e},changePresentableOnlineHandler:function(e){var t=this;e.isOnlineChecked?e.isOnline=1:e.isOnline=0,this.$services.presentables.put(e.presentableId,{isOnline:e.isOnline}).then(function(n){0===n.data.errcode||(e.isOnline=0,e.isOnlineChecked=!1,t.$message.error(n.data.msg||"更新失败"))}).catch(function(n){e.isOnline=0,e.isOnlineChecked=!1,t.$error.showErrorMessage(n)})},showSearchResourceHandler:function(){this.showSearchResource=!0},beforeCloseDialogHandler:function(){this.showSearchResource=!1},addResourceHandler:function(e){var t=this;this.createPresentable({nodeId:this.$route.params.nodeId,presentableName:e.resourceName,resourceId:e.resourceId}).then(function(e){t.presentableList.push(e),t.showSearchResource=!1}).catch(this.$error.showErrorMessage)},createPresentable:function(e){return this.$services.presentables.post(e).then(function(e){return 0!==e.data.errcode?Promise.reject(e.data.msg):e.getData()})},updatePresentableHandler:function(e){var t=this.currentPresentable.detail;Object.assign(t,e),this.resolvePresentable(t)}}},y=(n("PuKU"),Object(r.a)(S,function(){var e=this,t=e.$createElement,n=e._self._c||t;return n("section",{staticClass:"presentables-wrapper"},[n("div",{staticClass:"presentable-list-container"},[e._m(0),e._v(" "),n("ul",{staticClass:"presentable-list"},[e._l(e.presentableList,function(t,s){return n("li",{staticClass:"presentable-item",class:[t.isReady?"active-status-2":"active-status-0",{active:e.currentPresentable.index===s,"is-presentable-online":t.isOnlineChecked}],on:{click:function(n){e.changePresentableHandler(t,s)}}},[n("i",{staticClass:"dot"}),e._v(" "),n("freelog-switch",{staticClass:"node-res-status-switch",attrs:{"active-text":"上线","inactive-text":"下线"},on:{change:function(n){e.changePresentableOnlineHandler(t)}},model:{value:t.isOnlineChecked,callback:function(n){e.$set(t,"isOnlineChecked",n)},expression:"presentable.isOnlineChecked"}}),e._v(" "),n("span",{staticClass:"p-title"},[e._v(e._s(t.presentableName))])],1)}),e._v(" "),n("li",{staticClass:"presentable-item add-presentable-btn",on:{click:e.showSearchResourceHandler}},[n("i",{staticClass:"el-icon-plus"}),e._v("添加节点资源")])],2)]),e._v(" "),n("div",{directives:[{name:"show",rawName:"v-show",value:e.currentPresentable.detail.presentableId,expression:"currentPresentable.detail.presentableId"}],staticClass:"presentable-detail-container"},[n("presentable-detail",{tag:"component",staticClass:"presentable-detail-content",attrs:{detail:e.currentPresentable.detail},on:{update:e.updatePresentableHandler}})],1),e._v(" "),n("el-dialog",{attrs:{visible:e.showSearchResource,width:"840px","close-on-click-modal":!1,"before-close":e.beforeCloseDialogHandler,top:"10vh",center:""},on:{"update:visible":function(t){e.showSearchResource=t}}},[n("p",{staticClass:"dialog-title",attrs:{slot:"title"},slot:"title"},[e._v("添加资源")]),e._v(" "),n("search-resource",{staticClass:"add-resource-input",on:{add:e.addResourceHandler}})],1)],1)},[function(){var e=this.$createElement,t=this._self._c||e;return t("h4",[t("i",{staticClass:"el-icon-question"}),this._v("节点资源")])}],!1,null,"4713e4a5",null));t.default=y.exports},"0T9k":function(e,t,n){"use strict";var s=n("NN+/");n.n(s).a},"8SHQ":function(e,t,n){"use strict";var s={};n.r(s),n.d(s,"PRESENTABLE_STATUS_TIPS",function(){return r});var a=n("6ifa"),i=n("mL9P"),r=[{text:"测试状态",type:"info"},{text:"未开始执行",type:"danger"},{text:"执行中",type:"danger"},{text:"生效中",type:"success"},{text:"用户终止",type:"info"},{text:"系统终止",type:"info"}],c=n("DAk/");function o(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}t.a=function(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{},s=Object.keys(n);"function"==typeof Object.getOwnPropertySymbols&&(s=s.concat(Object.getOwnPropertySymbols(n).filter(function(e){return Object.getOwnPropertyDescriptor(n,e).enumerable}))),s.forEach(function(t){o(e,t,n[t])})}return e}({},a,i,s,c)},"8WhQ":function(e,t,n){},"DAk/":function(e,t,n){"use strict";n.r(t),n.d(t,"USER_GROUP_TYPE",function(){return s}),n.d(t,"NODE_GROUP_TYPE",function(){return a}),n.d(t,"GROUP_TYPES",function(){return i});var s=1,a=2,i=[{value:s,label:"用户分组"},{value:a,label:"节点分组"}]},G2YG:function(e,t,n){"use strict";var s=n("g67i");n.n(s).a},IP6f:function(e,t,n){"use strict";var s=n("3eXy");n("snnE");function a(e){return s.PresentablesService.get(e).then(function(e){return e.getData()})}var i=a;t.a={loadDetail:a,onloadPresentableDetail:i}},LxJW:function(e,t,n){"use strict";var s=n("y8CG");n.n(s).a},"NN+/":function(e,t,n){},NPCl:function(e,t,n){"use strict";var s=n("ULDT");n.n(s).a},PuKU:function(e,t,n){"use strict";var s=n("RAcy");n.n(s).a},RAcy:function(e,t,n){},TUsp:function(e,t,n){},ULDT:function(e,t,n){},WUQS:function(e,t,n){},g67i:function(e,t,n){},iwFP:function(e,t,n){"use strict";var s=n("8WhQ");n.n(s).a},kFP0:function(e,t,n){"use strict";var s=n("TUsp");n.n(s).a},"n8+z":function(e,t,n){"use strict";var s=n("WUQS");n.n(s).a},wmkz:function(e,t,n){"use strict";n.r(t);var s=n("7+cO"),a=n("IP6f"),i=n("aNms"),r=n("59r6"),c=n("qTA6"),o={name:"presentable-scheme-detail",components:{ResourceSchemeTree:s.a,ResourceIntroInfo:c.a},data:function(){return{isInitStatus:!1,params:this.$route.params,presentableDetail:{contracts:[],schemes:[],resourceInfo:{}},cachedContractsMap:{}}},mounted:function(){this.initView(this.params)},computed:{},watch:{},methods:{initView:function(e){var t=this;e.presentableId&&a.a.onloadPresentableDetail(e.presentableId).then(function(e){e&&e.contracts&&(t.isInitStatus=!e.contracts.length,e.contracts.slice(0).reduce(function(e,n){return e[t.getSchemeContractKey(n)]=n,e},t.cachedContractsMap),r.a.onloadResourceDetail(e.resourceId).then(function(n){console.log("detail",n),Object.assign(e.resourceInfo,n),e.resourceInfo.contracts=e.contracts,t.presentableDetail=e}))})},loadPresentableSchemes:function(e){var t=this;i.a.onloadSchemesForResource(e).then(function(e){console.log(e),t.presentableDetail.schemes=e})},getSchemeContractKey:function(e){return"".concat(e.authSchemeId,"_").concat(e.policySegmentId)},saveSchemeHandler:function(){var e,t=this,n=this.$refs.schemeTree.getDutyStatements(),s=this.presentableDetail.resourceId,a=this.cachedContractsMap,i=[];n.map(function(e){var n,s=e.selectedScheme,r={resourceId:e.resourceId};if(s?n={authSchemeId:s.authSchemeId,policySegmentId:s.selectedPolicy.segmentId}:e.policySegmentId&&(n={authSchemeId:e.authSchemeId,policySegmentId:e.policySegmentId}),n){var c=t.getSchemeContractKey(n);a[c]?r.contractId=a[c].contractId:Object.assign(r,n),i.push(r)}});for(var r=0;r<n.length;r++)if(n[r].resourceId===s){e=n[r];break}if(e)if(2===e.activeStatus){this.updatePresentableSchemes({contracts:function(e){var t=new Map;return e.filter(function(e){return!t.get(e.authSchemeId)&&(t.set(e.authSchemeId,1),!0)})}(i)})}else this.$message.error("有资源未选择授权策略");else console.log("error contracts",i),this.$message.error("未选择授权方案")},updatePresentableSchemes:function(e){var t=this;return this.$services.presentables.put(this.params.presentableId,e).then(function(e){0===e.data.errcode?(t.isInitStatus=!e.data.data.contracts.length,t.$message.success("更新成功"),t.gotoContractView(e.data.data)):t.$error.showErrorMessage(e)})},gotoContractView:function(e){for(var t={tab:"node-contracts"},n=0;n<e.contracts.length;n++){var s=e.contracts[n];if(s.resourceId===this.presentableDetail.resourceId){t.contractId=s.contractId;break}}this.$router.push({path:"/node/".concat(this.params.nodeId),query:t})},switchSchemeHandler:function(e,t,n,s){},selectResourceHandler:function(e,t,n,s){},changePolicy:function(e,t,n){},changeSchemePolicyHandler:function(e,t){},selectAuthSchemeHandler:function(e,t,n){}}},l=(n("iwFP"),n("LxJW"),n("KHd+")),u=Object(l.a)(o,function(){var e=this.$createElement,t=this._self._c||e;return t("div",{staticClass:"presentable-auth-scheme-wrap"},[t("resource-scheme-tree",{ref:"schemeTree",staticClass:"presentable-auth-scheme-tree",attrs:{contracts:this.presentableDetail.resourceInfo.contracts,resource:this.presentableDetail.resourceInfo}}),this._v(" "),t("div",{staticClass:"ft clearfix"},[t("div",{staticClass:"rt-side"},[t("el-button",{staticClass:"ft-btn deep-color-btn",attrs:{type:"primary",round:""},on:{click:this.saveSchemeHandler}},[this._v("\n        "+this._s(this.isInitStatus?"生成合约":"更新合约")+"\n      ")])],1)])],1)},[],!1,null,"2cfc91d5",null);t.default=u.exports},y8CG:function(e,t,n){}}]);