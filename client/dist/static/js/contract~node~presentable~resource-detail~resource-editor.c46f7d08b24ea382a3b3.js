(window.webpackJsonp=window.webpackJsonp||[]).push([["contract~node~presentable~resource-detail~resource-editor"],{"59r6":function(t,e,a){"use strict";a.d(e,"b",function(){return s}),a.d(e,"c",function(){return o});var n=a("3eXy"),r=(a("snnE"),a("LvDl"),a("C2Lv"));function s(t){return n.ResourceService.get(t).then(function(t){return 0===t.data.errcode?t.getData():Promise.reject(t.data)})}var o=function(t){return s(t).then(function(t){return t})};e.a={loadDetail:s,loadResources:function(t){return r.a.get("/v1/resources/list",{params:{resourceIds:t.join(",")}}).then(function(t){return t.getData()})},onloadResourceDetail:o}},"6ifa":function(t,e,a){"use strict";a.r(e),a.d(e,"CONTRACT_STATUS",function(){return n}),a.d(e,"CONTRACT_STATUS_TIPS",function(){return r}),a.d(e,"CONTRACT_STATUS_COLORS",function(){return s});var n={uncreated:-1,initial:1,running:2,activated:3,userTerminated:4,sysTerminated:5,terminated:6},r={"-1":"未创建合同",1:"未开始执行",2:"执行中",3:"生效中",4:"用户终止",5:"系统终止",6:"合同已终止"},s={"-1":{type:"danger",desc:"未创建合同"},1:{type:"warning",desc:"未开始执行"},2:{type:"warning",desc:"执行中"},3:{type:"success",desc:"生效中"},4:{type:"info",desc:"用户终止"},5:{type:"info",desc:"系统终止"},6:{type:"info",desc:"合同已终止"}}},"9K4q":function(t,e,a){"use strict";var n=a("Trkb");a.n(n).a},BAG8:function(t,e,a){"use strict";var n=a("wTFK");a.n(n).a},BZ6J:function(t,e,a){"use strict";var n=a("tnHd");a.n(n).a},ExDf:function(t,e,a){"use strict";a("bTlt");var n={name:"transaction-event",data:function(){return{options:[],fromAccountId:"",password:"",tipMsg:"",order:{},showError:!1}},mounted:function(){var t=this;this.$services.accounts.get().then(function(e){t.options=e.data.data}),this.queryOrder().then(this.checkOrderStatus.bind(this))},computed:{unitType:function(){return this.params.params[0].substr(0,4)}},props:["contractDetail","params"],methods:{payResultHandler:function(t){switch(t.status){case 1:this.$message.success("支付进行中，稍后查询支付结果");break;case 2:this.$message.success("支付成功");break;case 3:this.$message.success("支付失败");break;default:this.$message.info("未知的支付状态")}},doneHandler:function(t){this.order&&(t={shouldUpdate:!0}),this.$emit("close",t)},checkOrderStatus:function(t){if(t){var e;switch(this.order=t,t.status){case 1:e="支付进行中";break;case 2:e="已支付成功";break;case 3:e="支付失败"}this.tipMsg=e}},queryOrder:function(){return this.$services.orderInfo.get({params:{targetId:this.contractDetail.contractId}}).then(function(t){return t.getData()})},pay:function(){var t=this;this.$services.pay.post({targetId:this.contractDetail.contractId,orderType:1,fromAccountId:this.fromAccountId,toAccountId:this.params.params[0],amount:this.params.params[1],password:this.password}).then(function(e){0===e.data.errcode?(t.showError=!1,t.payResultHandler(e.data.data),t.doneHandler({shouldUpdate:!0,data:e.data.data})):(t.showError=!0,t.$message.error(e.data.msg))}).catch(this.$error.showErrorMessage)}}},r=(a("Kj8m"),a("KHd+")),s=Object(r.a)(n,function(){var t=this,e=t.$createElement,a=t._self._c||e;return a("div",{staticClass:"transaction-wrap"},[t.tipMsg?a("el-alert",{attrs:{title:t.tipMsg,type:"warning"}}):t._e(),t._v(" "),t.showError?a("el-alert",{attrs:{title:"",type:"warning"}},[t._v("\n      未设置支付密码，"),a("a",{staticStyle:{color:"#409EFF"},attrs:{href:"//www.freelog.com/pages/account/security.html",target:"_blank"}},[t._v("去设置")])]):t._e(),t._v(" "),a("el-form",{staticClass:"small-el-form",attrs:{"label-position":"left","label-width":"80px",model:t.contractDetail}},[a("el-form-item",{attrs:{label:"contractId"}},[t._v("\n        "+t._s(t.contractDetail.contractId)+"\n      ")]),t._v(" "),a("el-form-item",{attrs:{label:"甲方"}},[t._v("\n        "+t._s(t.contractDetail.partyOne)+"\n      ")]),t._v(" "),a("el-form-item",{attrs:{label:"乙方"}},[t._v("\n        "+t._s(t.contractDetail.partyTwo)+"\n      ")]),t._v(" "),a("el-form-item",{attrs:{label:"转入账号"}},[t._v("\n        "+t._s(t.params.params[0])+"\n      ")]),t._v(" "),a("el-form-item",{attrs:{label:"转账金额"}},[t._v("\n        "+t._s(t._f("humanizeCurrency")(t.params.params[1]))+" "+t._s(t.unitType)+"\n      ")]),t._v(" "),a("el-form-item",{attrs:{label:"转出账号"}},[a("el-select",{attrs:{size:"small",placeholder:"请选择"},model:{value:t.fromAccountId,callback:function(e){t.fromAccountId=e},expression:"fromAccountId"}},t._l(t.options,function(t){return a("el-option",{key:t.accountId,attrs:{label:t.accountId,value:t.accountId}})})),t._v(" "),a("el-tooltip",{attrs:{placement:"top"}},[a("div",{attrs:{slot:"content"},slot:"content"},[a("p",[a("a",{staticStyle:{color:"white"},attrs:{href:"//www.freelog.com/pages/account/create.html",target:"_blank"}},[t._v("没有账号？去添加一个")])])]),t._v(" "),a("i",{staticClass:"el-icon-question"})])],1),t._v(" "),a("el-form-item",{attrs:{label:"支付密码"}},[a("el-input",{staticStyle:{"max-width":"300px"},attrs:{type:"password",size:"small",placeholder:"请输入支付密码"},model:{value:t.password,callback:function(e){t.password=e},expression:"password"}})],1),t._v(" "),a("el-form-item",[a("el-button",{on:{click:t.doneHandler}},[t._v("取 消")]),t._v(" "),a("el-button",{attrs:{type:"primary",disabled:1==t.order.status||2==t.order.status},on:{click:t.pay}},[t._v("确 定")])],1)],1)],1)},[],!1,null,null,null).exports,o={name:"license-event",data:function(){return{accepted:!1,licenses:[]}},mounted:function(){this.loadLicenses()},props:["contractDetail","params"],methods:{loadLicenses:function(){var t=this,e=this.params.params.map(function(e){return t.loadLicenseContent(e)});Promise.all(e).then(function(e){t.licenses=e}).catch(this.$error.showErrorMessage)},loadLicenseContent:function(t){var e=this;return this.$axios.get("/v1/auths/resource/".concat(t,".data")).then(function(t){if(15!=t.getData().errcode)return t.getData();e.$message.warning("协议格式不正确，请联系合约作者。")})},signHandler:function(){var t=this;this.$services.signingLicenses.post({contractId:this.contractDetail.contractId,eventId:this.params.eventId,licenseIds:this.params.params,nodeId:this.$route.params.nodeId}).then(function(e){0===e.data.errcode?(t.$message.success("执行成功"),t.doneHandler(!0)):t.$message.error(e.data.msg)})},doneHandler:function(t){this.$emit("close",{shouldUpdate:t})}}},i=(a("q4R6"),Object(r.a)(o,function(){var t=this,e=t.$createElement,a=t._self._c||e;return a("div",{staticClass:"license-event-wrap"},[a("el-form",{staticClass:"small-el-form",attrs:{"label-position":"left","label-width":"80px",model:t.contractDetail}},[a("el-form-item",{attrs:{label:"协议"}},[a("div",{staticClass:"license-window"},t._l(t.licenses,function(e){return a("pre",{staticClass:"license-format"},[t._v("          "+t._s(e)+"\n        ")])}))]),t._v(" "),a("el-form-item",[a("el-checkbox",{staticClass:"accept-license",model:{value:t.accepted,callback:function(e){t.accepted=e},expression:"accepted"}},[t._v("接受协议")])],1),t._v(" "),a("div",{staticClass:"center"},[a("el-button",{on:{click:t.doneHandler}},[t._v("取 消")]),t._v(" "),a("el-button",{attrs:{type:"primary",disabled:!t.accepted},on:{click:t.signHandler}},[t._v("确 定")])],1)],1)],1)},[],!1,null,null,null).exports),c=(a("6ifa"),a("zQX5")),l={name:"contract-detail-info",data:function(){return{detail:null,refreshing:!1}},props:{data:{type:Object,default:function(){return{statusInfo:{}}}},shouldShowSegment:{type:Boolean,default:function(){return!0}},labelWidth:{type:Number,default:function(){return 100}},showRefreshing:{type:Boolean,default:function(){return!1}}},mounted:function(){this.render()},watch:{data:"render"},methods:{refreshHandler:function(){var t=this;this.refreshing=!0,this.$emit("refresh",{done:function(){t.refreshing=!1}})},render:function(){this.detail=c.a.format(this.data)}}},u=(a("BAG8"),Object(r.a)(l,function(){var t=this,e=t.$createElement,a=t._self._c||e;return t.detail?a("el-form",{staticClass:"small-el-form",attrs:{"label-position":"right","label-width":t.labelWidth+"px"}},[a("el-form-item",{attrs:{label:"合同ID"}},[t._v("\n    "+t._s(t.detail.contractId)+"\n  ")]),t._v(" "),a("el-form-item",{attrs:{label:"创建日期"}},[a("span",[t._v(t._s(t._f("fmtDate")(t.detail.createDate)))])]),t._v(" "),t.detail.statusInfo?a("el-form-item",{attrs:{label:"合同状态"}},[a("el-tag",{attrs:{type:t.detail.statusInfo.type}},[t._v("\n      "+t._s(t.detail.statusInfo.desc)+"\n    ")]),t._v(" "),t.showRefreshing&&t.detail.status<3?a("i",{staticClass:"el-icon-refresh",class:{"el-icon-loading":t.refreshing},on:{click:t.refreshHandler}}):t._e()],1):t._e(),t._v(" "),a("el-form-item",{attrs:{label:"状态机状态"}},[a("el-tag",{attrs:{type:3===t.detail.status?"success":"warning"}},[t._v("\n      "+t._s(t.detail.fsmState)+"\n    ")])],1),t._v(" "),a("el-form-item",{attrs:{label:"甲方"}},[t.detail.partyOneInfo?a("span",[t._v(t._s(t.detail.partyOneInfo.nickname))]):a("span",[t._v(t._s(t.detail.partyOne))])]),t._v(" "),a("el-form-item",{attrs:{label:"乙方"}},[t.detail.partyTwoInfo?a("span",[t._v(t._s(t.detail.partyTwoInfo.nodeName))]):a("span",[t._v(t._s(t.detail.partyTwo))])]),t._v(" "),t.detail.policySegment&&t.shouldShowSegment?a("el-form-item",{attrs:{label:"合同详情"}},[a("br"),t._v(" "),a("pre",{staticStyle:{overflow:"auto"}},[t._v(t._s(t.detail._segmentText))])]):t._e(),t._v(" "),t._t("default")],2):t._e()},[],!1,null,"efaf8024",null).exports),d=a("NKFe"),f=a.n(d),p={transaction:function(){return"支付事件"},signing:function(t){return"进入协议签署页面"},contractGuaranty:function(){return"进入支付保证金"},period:function(){return"周期性支付"},arrivalDate:function(t){return 1===t[0]?"到达日期"+t[1]+"进入下一个状态":0===t[0]?t[1]+"天后进入下一个状态":void 0}},m={name:"contract-content",data:function(){return{segmentDetail:""}},props:{data:{type:Object}},watch:{data:"render"},mounted:function(){this.render()},methods:{render:function(){this.currentEvents=this.resolveContractEvents(this.data),this.segmentDetail=this.parseContract(this.data)},cmdHandler:function(t){var e=t.target.dataset.action;this[e]&&this[e](t.target.dataset)},execEvent:function(t){this.$emit("execute",this.currentEvents[t.index])},resolveContractEvents:function(t){var e=[],a=t.fsmState,n=[];t.policySegment.fsmDescription.forEach(function(t){t.currentState===a&&n.push(t)});var r=function(t){var a=p[t.type];a&&e.push({desc:a(t.type),eventId:t.eventId,type:t.type,params:t.params})};return n.forEach(function(t){t.event&&("compoundEvents"===t.event.type?t.event.params.forEach(r):r(t.event))}),e},fillSpace:function(t){return t.replace(/^(\s+)/g,function(t){var e=new Array(t.length);return e.fill("&nbsp;"),e.join("")})},getState:function(t){var e=this.data,a=[];return t===e.fsmState&&a.push("cur-state"),e.policySegment.activatedStates.includes(t)&&a.push("active-state"),a.join(" ")},tagState:function(t){var e=this;return t=t.replace(/in (\S+)\s*:/,function(t,a){var n=e.escapeOutputState(a),r=e.getState(a),s='<span class="from-state '.concat(r,'" data-action="info" data-state="').concat(a,'">').concat(n,'<i class="el-icon-fa-arrow-circle-left cur-step-icon"></i></span>');return t.replace(a,s)})},getEvent:function(t){var e;return this.currentEvents.forEach(function(a,n){a.params.every(function(e){return t.includes(e)})&&((e=a).index=n)}),e},escapeOutputState:function(t){return t=t.replace("<","&lt;").replace(">","&gt;")},tagOperation:function(t){var e=this;return t=t.replace(/proceed\s+to\s+(\S+)\s+on\s+(.+)$/,function(t,a,n){var r=e.getEvent(n),s=-1,o=e.escapeOutputState(a),i='<span class="to-state">'.concat(o,"</span>"),c="";return r?(s=r.index,c='<span class="operation-tag" data-action="execEvent" data-index="'.concat(s,'">').concat(n,'<i class="el-icon-fa-hand-o-left cur-step-icon"></i></span>')):c='<span class="operation-tag">'.concat(n,"</span>"),t=(t=t.replace(a,i)).replace(n,c)})},parseContract:function(t){var e=this,a="";return f.a.beautify(t.policySegment.segmentText).split(/\n/).forEach(function(t){var n=e.fillSpace(t);n=e.tagState(n),n=e.tagOperation(n),a+="<p>".concat(n,"</p>")}),t._segmentDetail=a,a}}},h=(a("9K4q"),Object(r.a)(m,function(){var t=this.$createElement,e=this._self._c||t;return e("div",{staticClass:"contract-detail-content-wrapper"},[e("div",{domProps:{innerHTML:this._s(this.segmentDetail)},on:{click:this.cmdHandler}})])},[],!1,null,null,null).exports),v=a("59r6"),g={transaction:{type:"transaction-event",title:"支付"},signing:{type:"license-event",title:"签署"}},_={name:"presentable-contract-detail",data:function(){return{eventComponent:"",dialogTitle:"",showEventExecDialog:!1,loading:!0,contractDetail:{},resourceDetail:{},account:"",options:[],password:"",selectedContractEvent:""}},components:{TransactionEvent:s,LicenseEvent:i,ContractDetailInfo:u,ContractContent:h},props:{contractId:String},watch:{contractId:"initContractDetail"},mounted:function(){this.initContractDetail()},methods:{initContractDetail:function(){var t=this;this.contractId?this.loadContractDetail(this.contractId).then(function(e){Object(v.c)(e.resourceId).then(function(e){t.resourceDetail=e}),t.contractDetail=c.a.format(e),t.loading=!1}):this.loading=!1},handleCloseDialog:function(t){this.closeDialogHandler(),t()},closeDialogHandler:function(t){var e=this;t&&t.shouldUpdate&&setTimeout(function(){e.updateContractDetail()},500),this.eventComponent="",this.dialogTitle="",this.$refs.eventDialog.hide()},formatData:function(){var t=Object.assign({},this.contractDetail);t=c.a.format(t)},loadContractDetail:function(t){return this.$services.contract.get(t||{}).then(function(t){return t.getData()}).catch(this.$error.showErrorMessage)},updateContractDetail:function(t){var e=this;this.loadContractDetail(this.contractDetail.contractId).then(function(a){Object.assign(e.contractDetail,a),e.formatData(),t&&t.done&&t.done()})},executeContractHandler:function(t){var e=g[t.type];this.selectedContractEvent=t,this.eventComponent=e.type,this.dialogTitle=e.title,this.showEventExecDialog=!0},activateContractHandler:function(t){var e=this;this.$axios.get("/v1/contracts/initial",{params:{contractIds:t.contractId}}).then(function(a){0===a.data.errcode?(e.$message.success("成功激活合同"),e.loadContractDetail(t.contractId).then(function(a){Object.assign(t,a),e.$emit("update",c.a.format(t))})):e.$error.showErrorMessage(a.data.msg)})}}},b=(a("BZ6J"),Object(r.a)(_,function(){var t=this,e=t.$createElement,a=t._self._c||e;return t.contractDetail.contractId?a("section",[a("el-dialog",{ref:"eventDialog",attrs:{title:t.dialogTitle,visible:t.showEventExecDialog,"before-close":t.handleCloseDialog,center:!0,width:"40%"},on:{"update:visible":function(e){t.showEventExecDialog=e}}},[a(t.eventComponent,{tag:"component",attrs:{contractDetail:t.contractDetail,params:t.selectedContractEvent},on:{close:t.closeDialogHandler}})],1),t._v(" "),a("div",{directives:[{name:"loading",rawName:"v-loading",value:t.loading,expression:"loading"}]},[a("el-form",{attrs:{"label-width":"120px"}},[a("el-form-item",{staticStyle:{"margin-bottom":"0"},attrs:{label:"资源名称"}},[t._v("\n        "+t._s(t.resourceDetail.resourceName)+"\n      ")]),t._v(" "),a("el-form-item",{staticStyle:{"margin-bottom":"0"},attrs:{label:"资源类型"}},[t._v("\n        "+t._s(t.resourceDetail.resourceType)+"\n      ")])],1),t._v(" "),a("contract-detail-info",{attrs:{data:t.contractDetail,showRefreshing:!0,labelWidth:120,shouldShowSegment:!1},on:{refresh:t.updateContractDetail}},[a("el-form-item",{attrs:{label:"合同详情"}},[a("contract-content",{attrs:{data:t.contractDetail},on:{execute:t.executeContractHandler}})],1),t._v(" "),1===t.contractDetail.status?a("el-form-item",{staticClass:"flex-grid",attrs:{label:"激活合同"}},[a("el-button",{attrs:{size:"small"},on:{click:function(e){t.activateContractHandler(t.contractDetail)}}},[t._v("立即激活\n        ")])],1):t._e()],1)],1)],1):t._e()},[],!1,null,"31378189",null));e.a=b.exports},JwYz:function(t,e,a){},Kj8m:function(t,e,a){"use strict";var n=a("JwYz");a.n(n).a},Trkb:function(t,e,a){},XflS:function(t,e,a){},q4R6:function(t,e,a){"use strict";var n=a("XflS");a.n(n).a},tnHd:function(t,e,a){},wTFK:function(t,e,a){},zQX5:function(t,e,a){"use strict";var n=a("NKFe"),r=a.n(n),s=(a("1O/z"),a("tpTV"),a("6ifa"));a("oCYn");e.a={format:function(t){if(t)return t.policySegment&&(t._segmentText=r.a.beautify(t.policySegment.segmentText).trim(),t.forUsers=t.policySegment.users.map(function(t){return{users:t.users.join("、"),type:t.userType}})),t.statusInfo=s.CONTRACT_STATUS_COLORS[t.status],t}}}}]);