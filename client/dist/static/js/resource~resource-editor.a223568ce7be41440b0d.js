(window.webpackJsonp=window.webpackJsonp||[]).push([["resource~resource-editor"],{"+Ayt":function(e,t,a){},AVS1:function(e,t,a){"use strict";var r=a("vGVs");a.n(r).a},HNda:function(e,t,a){},WnEl:function(e,t,a){"use strict";var r=a("HNda");a.n(r).a},ZtKZ:function(e,t,a){"use strict";var r=a("xdn2");a.n(r).a},qqKF:function(e,t,a){"use strict";var r=a("j5TT");a("AQno"),a("aX69"),a("y8iW"),a("SJVZ"),a("osHv"),a("rt3J"),a("jXCp"),a("jDMi"),a("uhTo"),a("mki7"),a("I96o"),a("uTOq"),a("19Vz");var o={tabSize:4,mode:"text/html",theme:"dracula",lineNumbers:!0,line:!0,keyMap:"sublime",extraKeys:{Ctrl:"autocomplete"},lineWrapping:!0,foldGutter:!0,gutters:["CodeMirror-linenumbers","CodeMirror-foldgutter"],styleSelectedText:!0,highlightSelectionMatches:{showToken:/\w/,annotateScrollbar:!0}},s=a("DzJC");a("uGbe");var i={name:"resource-meta-info",data:function(){var e=Object.assign({},o);return Object.assign(e,{mode:"application/json",viewportMargin:1/0,theme:"idea",lineNumbers:!1,gutters:[]}),{errorMsg:"",editorOptions:e,data:this.value}},components:{codemirror:r.codemirror},props:{value:{type:String,default:function(){return""}}},watch:{value:function(){this.data=this.value}},mounted:function(){},methods:{onCodeChange:function(e){var t=this;this.data=e,this.validator?this.validator():this.validator=s(function(){t.validateJSON()},2e3),this.$emit("input",this.data)},validateJSON:function(){try{this.data&&JSON.parse(this.data),this.clearErrorMsg()}catch(e){this.errorMsg="JSON格式有误！"+e}this.$emit("validate",this.errorMsg)},clearErrorMsg:function(){this.errorMsg=""}}},n=(a("ZtKZ"),a("KHd+")),l=Object(n.a)(i,function(){var e=this.$createElement,t=this._self._c||e;return t("section",{staticClass:"meta-editor-wrap"},[t("el-alert",{directives:[{name:"show",rawName:"v-show",value:this.errorMsg,expression:"errorMsg"}],staticStyle:{"margin-bottom":"15px"},attrs:{title:this.errorMsg,"show-icon":"",type:"error"},on:{close:this.clearErrorMsg}}),this._v(" "),t("codemirror",{ref:"codeMirror",attrs:{code:this.data,options:this.editorOptions,placeholder:"描述资源meta信息的JSON数据"},on:{change:this.onCodeChange}})],1)},[],!1,null,null,null).exports,c=a("11pw"),d=a("mL9P"),u=(a("gJae"),a("p1OT"),a("FOEY"),a("lT11")),p={name:"fl-rich-editor",data:function(){var e=this;return{editor:null,showImgUploader:!1,content:"",editorOption:{placeholder:this.placeholder,modules:{toolbar:{container:[["bold","italic","underline","strike"],["blockquote","code-block"],[{list:"ordered"},{list:"bullet"}],[{size:["small",!1,"large","huge"]}],[{color:[]},{background:[]}],["link","image","video"]],handlers:{image:function(){e.showImgUploader=!0,e.uploadImgState={cursorIndex:this.quill.selection.savedRange.index}}}}}}}},props:{value:{type:String,default:function(){return""}},config:{type:Object,default:function(){return{}}},placeholder:String},watch:{},mounted:function(){var e=this;if(this.createEditor(),this.$route.params.resourceId)var t=this.$watch("value",function(){e.value&&(e.content=e.value),t()})},components:{"quill-rich-editor":u.quillEditor},methods:{uploadImageSuccessHandler:function(e,t){this.$emit("load",{file:t,data:e}),this.resetImgUploaderState()},uploadImageErrorHandler:function(){this.resetImgUploaderState()},resetImgUploaderState:function(){this.$refs.imgUploader.clearFiles(),this.uploadImgState.cursorIndex="",this.showImgUploader=!1},createEditor:function(){this.editor=this.$refs.richEditor.quill,this.setHtml(this.value||"")},getHtml:function(){return this.content},setHtml:function(e){this.editor?this.editor.setContents(e):console.warn("还未创建编辑器")},insertImg:function(e){this.editor.insertEmbed(this.uploadImgState.cursorIndex,"image",e)},getEditor:function(){return this.editor},onEditorBlur:function(e){},onEditorFocus:function(e){},onEditorReady:function(e){},onEditorChange:function(e){e.quill;var t=e.html;e.text;this.$emit("input",t)}}},m=(a("WnEl"),"creator"),h="editor",g={name:"base-resource-creator",components:{ResourceMetaInfo:l,RichEditor:Object(n.a)(p,function(){var e=this,t=e.$createElement,a=e._self._c||t;return a("div",{staticClass:"rich-editor-wrapper"},[a("quill-rich-editor",{ref:"richEditor",staticClass:"rich-text-editor",attrs:{options:e.editorOption},on:{blur:function(t){e.onEditorBlur(t)},focus:function(t){e.onEditorFocus(t)},ready:function(t){e.onEditorReady(t)},change:function(t){e.onEditorChange(t)}},model:{value:e.content,callback:function(t){e.content=t},expression:"content"}}),e._v(" "),a("el-dialog",{attrs:{visible:e.showImgUploader,center:"",width:"500px"},on:{"update:visible":function(t){e.showImgUploader=t}}},[a("el-upload",{ref:"imgUploader",staticClass:"rich-editor-upload-img",attrs:{drag:"",action:"/api/v1/resources/upoladPreviewImage","on-success":e.uploadImageSuccessHandler,"on-error":e.uploadImageErrorHandler,"auto-upload":!0}},[a("i",{staticClass:"el-icon-upload"}),e._v(" "),a("div",{staticClass:"el-upload__text"},[e._v("点击上传或将图片拖到此处")])])],1)],1)},[],!1,null,null,null).exports},data:function(){var e=this;return{ResourceTypes:d.RESOURCE_TYPES,rules:{resourceName:[{required:!0,message:"请输入资源名称",trigger:"blur"}],widgetName:[{validator:function(t,a,r){e.formData.resourceType!==d.RESOURCE_TYPES.widget||/^freelog-[a-z0-9._-]{3,15}-[a-z0-9._-]{2,14}[a-z0-9]$/.test(a)?r():r(new Error("例如freelog-namespace-widgetname，namespace和widgetname至少3个字符"))},trigger:"blur"}],resourceType:[{required:!0,message:"请选择资源类型",trigger:"blur"},{validator:function(e,t,a){var r=/^[a-z]{1}[0-9a-z_]{2,19}[0-9a-z]{1}$/;r.test(t)?a():a(new Error("命名格式有误，需满足"+r.toString()))},trigger:"blur"}]},options:Object.keys(d.RESOURCE_TYPES).map(function(e){return{label:e,value:d.RESOURCE_TYPES[e]}}),loading:!1,formData:{resourceType:c.c.get("CREATE_RESOURCE_TYPE")||d.RESOURCE_TYPES.widget,resourceName:"",widgetName:"",description:"",previewImage:""},uploader:{headers:{method:"POST"}},valid:!1,meta:"{}",editMode:m,editorConfig:{},percentage:0,currentUploader:"",uploaderStates:{resource:{percentage:0,isUploaded:!1,isUploading:!1,name:""},thumbnail:{percentage:0,isUploaded:!1,isUploading:!1,name:""}}}},props:{data:{type:Object,default:function(){return{}}}},computed:{showCreatorInputItem:function(){return this.editMode===m},shouldShowResourceUploader:function(){return!(this.uploaderStates.resource.isUploading||this.uploaderStates.resource.isUploaded)},shouldShowThumbnailInput:function(){return this.formData.resourceType===d.RESOURCE_TYPES.pageBuild}},watch:{data:function(){if(this.data.resourceId&&(this.editMode=h,Object.assign(this.formData,this.data),this.formData.widgetName=this.data.systemMeta.widgetName||"",this.data.previewImages.length&&(this.formData.previewImage=this.data.previewImages[0]),this.data.meta))try{this.meta=JSON.stringify(this.data.meta)}catch(e){this.meta="{}"}}},mounted:function(){this.resourceTypeChange(this.formData.resourceType)},methods:{resourceTypeChange:function(e){c.c.set("CREATE_RESOURCE_TYPE",e)},checkMetaValid:function(e){this.valid=e},errorHandler:function(e){var t,a;if(this.loading=!1,void 0!==e.errcode)a={error:e.msg};else{switch(e.status){case 400:t="不支持的文件类型";break;case 401:t="权限未经验证";break;default:t=e.message}a={error:t}}this.$emit("uploadEnd",a),this.$refs.resourceUploader.fileList=[]},successHandler:function(e,t){this.loading=!1,0!==e.ret||0!==e.errcode?(this.$refs.resourceUploader.clearFiles(),this.uploaderStates.resource.isUploading=!1,this.uploaderStates.resource.percentage=0,this.$message.error(e.msg),this.$emit("uploadEnd",{error:e.msg})):(this.uploaderStates.resource.sha1=e.data.sha1,this.uploaderStates.resource.isUploaded=!0,this.uploaderStates.resource.percentage=100,this.autoSetFormData(t),this.$emit("uploadEnd",e.data))},autoSetFormData:function(e){var t=e.name.split(".");t.length>1&&t.pop(),t=t.join("."),this.formData.widgetName||this.formData.resourceType!==d.RESOURCE_TYPES.widget||(this.formData.widgetName=t),this.formData.resourceName||(this.formData.resourceName=t)},fileChangeHandler:function(e,t){this.fileLimitValidator(e,t)},imageUploadSuccessHandler:function(e){this.uploaderStates.thumbnail.isUploading=!1,0===e.errcode?(this.formData.previewImage=e.data,this.uploaderStates.thumbnail.isUploaded=!0,this.uploaderStates.thumbnail.percentage=100):(this.uploaderStates.thumbnail.percentage=0,this.$error.showErrorMessage(e.msg))},previewImageChangeHandler:function(e,t){this.fileLimitValidator(e,t)},validateImageHandler:function(e){return/\.(jpg|png|gif|tiff|webp)$/.test(e.name)?(this.resetUploaderState(this.uploaderStates.thumbnail),!0):(this.$message.error("不支持的图片类型"),!1)},clearUploaderHandler:function(e){var t,a=this.uploaderStates[e];(t="resource"===e?this.$refs.resourceUploader:this.$refs.thumbnailUploader).clearFiles(),t.abort(a.file),Object.assign(a,{sha1:"",name:"",isUploading:!1,isUploaded:!1,percentage:0})},beforeUploadHandler:function(e){this.resetUploaderState(this.uploaderStates.resource,e)},resetUploaderState:function(e,t){Object.assign(e,{file:t,name:t&&t.name||"",isUploading:!0,isUploaded:!1,percentage:0})},imgUploadSuccessHandler:function(e){var t=e.data,a=this.$refs.editor;0===t.errcode?a.insertImg(t.data):this.$message.error(t.msg)},validate:function(){var e=this;return new Promise(function(t,a){var r=e.uploaderStates.resource;e.$refs.createForm.validate(function(o,s){if(o){var i;if(e.editMode===m)if(r.sha1?r.isUploaded||(i="资源文件正在上传中，等上传完再点击创建"):i="未上传资源文件",i)return a(i);try{JSON.parse(e.meta)}catch(s){return console.error(s),a("meta格式有误: ".concat(s))}t()}else{var n=Object.keys(s).map(function(e){return s[e].message});a(n.join("，"))}})})},fileLimitValidator:function(e,t){return!(t.length>1)||(t.shift(),!1)},packUploadData:function(){var e,t=this.uploaderStates.resource,a={},r=this.formData,o=["resourceName"];try{e=JSON.parse(this.meta)}catch(t){e={}}this.formData.widgetName&&(e.widgetName=this.formData.widgetName),this.editMode===m?(o=o.concat(["resourceType"]),a.sha1=t.sha1,r.previewImage&&(a.previewImage=r.previewImage)):r.previewImage&&(a.previewImages=[r.previewImage]),a.meta=e;var s=this.$refs.editor.getHtml();return s&&(a.description=s),o.forEach(function(e){r[e]&&(a[e]=r[e])}),console.log(a),a},isChanged:function(){return!0},nextHandler:function(){var e=this;return new Promise(function(t,a){e.validate().then(function(){var r=e.packUploadData();e.data.resourceId?e.isChanged()?e.updateResource(r).then(t).catch(a):t():e.createResource(r).then(t).catch(a)}).catch(a)})},createResource:function(e){var t=this;return new Promise(function(a,r){t.$refs.resourceUploader.uploadFiles.length>0?t.$services.resource.post(e).then(function(e){0!==e.data.ret||0!==e.data.errcode?r(e.data.msg):a(e.data.data)}):r("无上传文件")})},updateResource:function(e){return this.$services.resource.put(this.data.resourceId,e).then(function(e){return 0!==e.data.ret||0!==e.data.errcode?Promise.reject(e):e.getData()})},uploadProgressHandler:function(e,t,a){var r,o=this.uploaderStates;o.resource.name===t.name?r=o.resource:o.thumbnail.name===t.name&&(r=o.thumbnail),r&&(r.percentage=t.percentage)}}},f=(a("tDFS"),a("AVS1"),Object(n.a)(g,function(){var e=this,t=e.$createElement,a=e._self._c||t;return a("div",{staticClass:"base-resource-wrap",class:["resource-edit-mode-"+e.editMode]},[a("el-form",{ref:"createForm",attrs:{model:e.formData,"label-width":"0",rules:e.rules}},[a("el-form-item",[a("div",{staticClass:"uploader-wrapper"},[e.shouldShowThumbnailInput?a("div",{staticClass:"resource-thumbnail-input"},[a("el-upload",{directives:[{name:"show",rawName:"v-show",value:!e.uploaderStates.thumbnail.isUploading,expression:"!uploaderStates.thumbnail.isUploading"}],ref:"thumbnailUploader",staticClass:"resource-thumbnail-uploader",attrs:{drag:"",action:"/api/v1/resources/upoladPreviewImage",data:e.uploader.data,headers:e.uploader.headers,"on-error":e.errorHandler,"on-change":e.previewImageChangeHandler,"on-success":e.imageUploadSuccessHandler,"before-upload":e.validateImageHandler,"on-progress":e.uploadProgressHandler,"show-file-list":!1,"auto-upload":!0}},[e.formData.previewImage?a("img",{staticStyle:{height:"100%"},attrs:{src:e.formData.previewImage,alt:""}}):[a("i",{staticClass:"el-icon-plus"}),e._v(" "),a("div",{staticClass:"resource-file-tip"},[a("p",[e._v("资源预览图")]),e._v(" "),a("p",{staticClass:"resource-file-sub-tip"},[e._v("800X600")])])]],2),e._v(" "),a("div",{directives:[{name:"show",rawName:"v-show",value:e.uploaderStates.thumbnail.isUploading,expression:"uploaderStates.thumbnail.isUploading"}],staticClass:"thumbnail-upload-state"},[a("p",[e._v("资源预览图")]),e._v(" "),a("div",[a("i",{staticClass:"el-icon-circle-close",on:{click:function(t){e.clearUploaderHandler("thumbnail")}}}),e._v(" "),a("el-progress",{staticStyle:{"margin-right":"20px"},attrs:{"stroke-width":10,percentage:e.uploaderStates.thumbnail.percentage,color:"#333333"}})],1)])],1):e._e(),e._v(" "),a("div",{staticClass:"resource-file-input"},[a("div",{directives:[{name:"show",rawName:"v-show",value:!0===e.shouldShowResourceUploader,expression:"shouldShowResourceUploader === true"}],staticClass:"resource-file-uploader-wrap"},[e.showCreatorInputItem?a("el-upload",{ref:"resourceUploader",staticClass:"resource-file-uploader",attrs:{drag:"",action:"/api/v1/resources/uploadResourceFile",multiple:!1,data:{resourceType:e.formData.resourceType},headers:e.uploader.headers,"before-upload":e.beforeUploadHandler,"on-error":e.errorHandler,"on-change":e.fileChangeHandler,"on-success":e.successHandler,"show-file-list":!1,"on-progress":e.uploadProgressHandler,"auto-upload":!0}},[a("i",{staticClass:"el-icon-plus"}),e._v(" "),a("div",{staticClass:"resource-file-tip"},[a("p",[e._v("资源文件")]),e._v(" "),a("p",{staticClass:"resource-file-sub-tip"},[e._v("拖拽或点击上传，最大不超过50M")])])]):e._e(),e._v(" "),e.uploaderStates.resource.isUploading?e._e():a("el-select",{staticClass:"resource-type",attrs:{disabled:!e.showCreatorInputItem,"allow-create":"",filterable:"",placeholder:"资源类型"},on:{change:e.resourceTypeChange},model:{value:e.formData.resourceType,callback:function(t){e.$set(e.formData,"resourceType",t)},expression:"formData.resourceType"}},e._l(e.options,function(e){return a("el-option",{key:e.value,attrs:{label:e.label,value:e.value}})}))],1),e._v(" "),a("div",{directives:[{name:"show",rawName:"v-show",value:!1===e.shouldShowResourceUploader,expression:"shouldShowResourceUploader === false"}],staticClass:"resource-upload-state"},[a("div",{staticClass:"resource-type-desc"},[e._v("资源文件类型："+e._s(e.formData.resourceType))]),e._v(" "),a("div",[a("i",{staticClass:"el-icon-circle-close",on:{click:function(t){e.clearUploaderHandler("resource")}}}),e._v(" "),e.shouldShowResourceUploader?e._e():a("el-progress",{staticClass:"resource-file-progress",attrs:{"stroke-width":10,percentage:e.uploaderStates.resource.percentage,color:"#333333"}})],1)])])])]),e._v(" "),a("el-form-item",{attrs:{prop:"resourceName"}},[a("input",{directives:[{name:"model",rawName:"v-model",value:e.formData.resourceName,expression:"formData.resourceName"}],staticClass:"input-item resource-name",attrs:{type:"text",placeholder:"资源标题"},domProps:{value:e.formData.resourceName},on:{input:function(t){t.target.composing||e.$set(e.formData,"resourceName",t.target.value)}}})]),e._v(" "),a("el-form-item",{directives:[{name:"show",rawName:"v-show",value:e.formData.resourceType===e.ResourceTypes.widget,expression:"formData.resourceType === ResourceTypes.widget"}],attrs:{prop:"widgetName"}},[a("input",{directives:[{name:"model",rawName:"v-model",value:e.formData.widgetName,expression:"formData.widgetName"}],staticClass:"input-item widget-name",attrs:{type:"text",disabled:!e.showCreatorInputItem,placeholder:"widget名称"},domProps:{value:e.formData.widgetName},on:{input:function(t){t.target.composing||e.$set(e.formData,"widgetName",t.target.value)}}})]),e._v(" "),a("el-form-item",{attrs:{prop:"description"}},[a("rich-editor",{ref:"editor",staticClass:"res-desc-editor",attrs:{width:"100%",config:e.editorConfig,placeholder:"请输入资源描述"},on:{load:e.imgUploadSuccessHandler},model:{value:e.formData.description,callback:function(t){e.$set(e.formData,"description",t)},expression:"formData.description"}})],1),e._v(" "),a("el-form-item",[a("h4",{staticClass:"step-title"},[e._v("资源meta信息")]),e._v(" "),a("resource-meta-info",{attrs:{placeholder:"资源meta信息"},on:{validate:e.checkMetaValid},model:{value:e.meta,callback:function(t){e.meta=t},expression:"meta"}})],1)],1)],1)},[],!1,null,"0043d261",null));t.a=f.exports},tDFS:function(e,t,a){"use strict";var r=a("+Ayt");a.n(r).a},vGVs:function(e,t,a){},xdn2:function(e,t,a){}}]);