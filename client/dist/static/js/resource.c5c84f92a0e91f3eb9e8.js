(window.webpackJsonp=window.webpackJsonp||[]).push([["resource"],{"59r6":function(e,t,r){"use strict";r.d(t,"b",function(){return o}),r.d(t,"c",function(){return i});var a=r("3eXy"),s=(r("snnE"),r("LvDl"),r("C2Lv"));function o(e){return a.ResourceService.get(e).then(function(e){return 0===e.data.errcode?e.getData():Promise.reject(e.data)})}var i=function(e){return o(e).then(function(e){return e})};t.a={loadDetail:o,loadResources:function(e){return s.a.get("/v1/resources/list",{params:{resourceIds:e.join(",")}}).then(function(e){return e.getData()})},onloadResourceDetail:i}},AVS1:function(e,t,r){"use strict";var a=r("N+CQ");r.n(a).a},"E/nT":function(e,t,r){},"M/2d":function(e,t,r){},MiEe:function(e,t,r){},"N+CQ":function(e,t,r){},WnEl:function(e,t,r){"use strict";var a=r("M/2d");r.n(a).a},ZtKZ:function(e,t,r){"use strict";var a=r("bPgk");r.n(a).a},bPgk:function(e,t,r){},"cDW+":function(e,t,r){"use strict";r.r(t);var a=r("qqKF"),s=r("59r6"),o=(r("11pw"),{name:"resource-creator",components:{BaseResourceCreator:a.a},data:function(){return{resourceDetail:{}}},mounted:function(){var e=this,t=this.$route.params;t.resourceId&&s.a.loadDetail(t.resourceId).then(function(t){e.resourceDetail=t}).catch(this.$error.showErrorMessage)},methods:{executeNext:function(e){var t=this;this.$refs.inputArea.nextHandler?this.$refs.inputArea.nextHandler(this.data).then(function(r){r&&r.resourceId&&Object.assign(t.resourceDetail,r),e()}).catch(this.$error.showErrorMessage):e()},create2QuitHandler:function(){var e=this;this.executeNext(function(){var t=e.resourceDetail;e.$route.params.resourceId?e.$message.success("资源更新成功"):e.$message.success("资源创建成功"),setTimeout(function(){e.$router.push("/resource/detail/".concat(t.resourceId))},500)})},create2AddHandler:function(){var e=this,t=this.resourceDetail;this.executeNext(function(){t.resourceId&&e.$router.push("/resource/detail/".concat(t.resourceId,"/auth_schemes"))})}}}),i=(r("eEJI"),r("KHd+")),n=Object(i.a)(o,function(){var e=this.$createElement,t=this._self._c||e;return t("section",{staticClass:"create-resource-wrapper"},[t("div",{staticClass:"bd"},[t("base-resource-creator",{ref:"inputArea",attrs:{data:this.resourceDetail}})],1),this._v(" "),t("div",{staticClass:"ft"},[t("div",{staticClass:"btm-wrap clearfix"},[t("div",{staticClass:"rt-side"},[t("el-button",{staticClass:"ft-btn gray-btn",attrs:{type:"text"},on:{click:this.create2QuitHandler}},[this._v("完成并退出")]),this._v(" "),t("el-button",{staticClass:"ft-btn deep-color-btn",attrs:{type:"primary",round:""},on:{click:this.create2AddHandler}},[this._v("\n          完成并添加授权\n        ")])],1)])])])},[],!1,null,"8bf44d70",null);t.default=n.exports},eEJI:function(e,t,r){"use strict";var a=r("E/nT");r.n(a).a},mL9P:function(e,t,r){"use strict";r.r(t),r.d(t,"RESOURCE_TYPES",function(){return a}),r.d(t,"RESOURCE_STATUS",function(){return s});var a={widget:"widget",image:"image",audio:"audio",markdown:"markdown",pageBuild:"page_build",revealSlide:"reveal_slide",license:"license"},s=[{desc:"未知状态",type:"danger"},{desc:"未发布",type:"warning"},{desc:"已发布",type:"success"},{desc:"冻结",type:"danger"}]},qqKF:function(e,t,r){"use strict";var a=r("j5TT");r("p77/"),r("AQno"),r("aX69"),r("y8iW"),r("SJVZ"),r("osHv"),r("rt3J"),r("jXCp"),r("jDMi"),r("uhTo"),r("mki7"),r("I96o"),r("uTOq"),r("19Vz");var s={tabSize:4,mode:"text/html",theme:"dracula",lineNumbers:!0,line:!0,keyMap:"sublime",extraKeys:{Ctrl:"autocomplete"},lineWrapping:!0,foldGutter:!0,gutters:["CodeMirror-linenumbers","CodeMirror-foldgutter"],styleSelectedText:!0,highlightSelectionMatches:{showToken:/\w/,annotateScrollbar:!0}},o=(r("+dQi"),r("DzJC"));r("uGbe");var i={name:"resource-meta-info",data:function(){var e=Object.assign({},s);return Object.assign(e,{mode:{name:"javascript",json:!0},viewportMargin:1/0,theme:"idea",lineNumbers:!1,gutters:[]}),{errorMsg:"",editorOptions:e,data:this.value}},components:{codemirror:a.codemirror},props:{value:{type:String,default:function(){return""}}},watch:{value:function(){this.data=this.value}},mounted:function(){},methods:{onCodeChange:function(e){var t=this;this.data=e,this.validator?this.validator():this.validator=o(function(){t.validateJSON()},2e3),this.$emit("input",this.data)},validateJSON:function(){try{this.data&&JSON.parse(this.data),this.clearErrorMsg()}catch(e){this.errorMsg="JSON格式有误！"+e}this.$emit("validate",this.errorMsg)},clearErrorMsg:function(){this.errorMsg=""}}},n=(r("ZtKZ"),r("KHd+")),c=Object(n.a)(i,function(){var e=this.$createElement,t=this._self._c||e;return t("section",{staticClass:"meta-editor-wrap"},[t("el-alert",{directives:[{name:"show",rawName:"v-show",value:this.errorMsg,expression:"errorMsg"}],staticStyle:{"margin-bottom":"15px"},attrs:{title:this.errorMsg,"show-icon":"",type:"error"},on:{close:this.clearErrorMsg}}),this._v(" "),t("codemirror",{ref:"codeMirror",attrs:{code:this.data,options:this.editorOptions,placeholder:"描述资源meta信息的JSON数据"},on:{input:this.onCodeChange}})],1)},[],!1,null,null,null).exports,l=r("11pw"),u=r("mL9P"),d=(r("gJae"),r("p1OT"),r("FOEY"),r("lT11")),p={name:"fl-rich-editor",data:function(){var e=this;return{editor:null,showImgUploader:!1,content:"",editorOption:{placeholder:this.placeholder,modules:{toolbar:{container:[["bold","italic","underline","strike"],["blockquote","code-block"],[{list:"ordered"},{list:"bullet"}],[{size:["small",!1,"large","huge"]}],[{color:[]},{background:[]}],["link","image","video"]],handlers:{image:function(){e.showImgUploader=!0,e.uploadImgState={cursorIndex:this.quill.selection.savedRange.index}}}}}}}},props:{value:{type:String,default:function(){return""}},config:{type:Object,default:function(){return{}}},placeholder:String},watch:{},mounted:function(){var e=this;if(this.createEditor(),this.$route.params.resourceId)var t=this.$watch("value",function(){e.value&&(e.content=e.value),t()})},components:{"quill-rich-editor":d.quillEditor},methods:{uploadImageSuccessHandler:function(e,t){this.$emit("load",{file:t,data:e}),this.resetImgUploaderState()},uploadImageErrorHandler:function(){this.resetImgUploaderState()},resetImgUploaderState:function(){this.$refs.imgUploader.clearFiles(),this.uploadImgState.cursorIndex="",this.showImgUploader=!1},createEditor:function(){this.editor=this.$refs.richEditor.quill,this.setHtml(this.value||"")},getHtml:function(){return this.content},setHtml:function(e){this.editor?this.editor.setContents(e):console.warn("还未创建编辑器")},insertImg:function(e){this.editor.insertEmbed(this.uploadImgState.cursorIndex,"image",e)},getEditor:function(){return this.editor},onEditorBlur:function(e){},onEditorFocus:function(e){},onEditorReady:function(e){},onEditorChange:function(e){e.quill;var t=e.html;e.text;this.$emit("input",t)}}},h=(r("WnEl"),"creator"),m="editor",f={name:"base-resource-creator",components:{ResourceMetaInfo:c,RichEditor:Object(n.a)(p,function(){var e=this,t=e.$createElement,r=e._self._c||t;return r("div",{staticClass:"rich-editor-wrapper"},[r("quill-rich-editor",{ref:"richEditor",staticClass:"rich-text-editor",attrs:{options:e.editorOption},on:{blur:function(t){e.onEditorBlur(t)},focus:function(t){e.onEditorFocus(t)},ready:function(t){e.onEditorReady(t)},change:function(t){e.onEditorChange(t)}},model:{value:e.content,callback:function(t){e.content=t},expression:"content"}}),e._v(" "),r("el-dialog",{attrs:{visible:e.showImgUploader,center:"",width:"500px"},on:{"update:visible":function(t){e.showImgUploader=t}}},[r("el-upload",{ref:"imgUploader",staticClass:"rich-editor-upload-img",attrs:{drag:"",action:"/api/v1/resources/upoladPreviewImage","on-success":e.uploadImageSuccessHandler,"on-error":e.uploadImageErrorHandler,"auto-upload":!0}},[r("i",{staticClass:"el-icon-upload"}),e._v(" "),r("div",{staticClass:"el-upload__text"},[e._v("点击上传或将图片拖到此处")])])],1)],1)},[],!1,null,null,null).exports},data:function(){var e=this;return{ResourceTypes:u.RESOURCE_TYPES,rules:{resourceName:[{required:!0,message:"请输入资源名称",trigger:"blur"}],widgetName:[{validator:function(t,r,a){e.formData.resourceType!==u.RESOURCE_TYPES.widget||/^freelog-[a-z0-9._-]{3,15}-[a-z0-9._-]{2,14}[a-z0-9]$/.test(r)?a():a(new Error("例如freelog-namespace-widgetname，namespace和widgetname至少3个字符"))},trigger:"blur"}],resourceType:[{required:!0,message:"请选择资源类型",trigger:"blur"},{validator:function(e,t,r){var a=/^[a-z]{1}[0-9a-z_]{2,19}[0-9a-z]{1}$/;a.test(t)?r():r(new Error("命名格式有误，需满足"+a.toString()))},trigger:"blur"}]},options:Object.keys(u.RESOURCE_TYPES).map(function(e){return{label:e,value:u.RESOURCE_TYPES[e]}}),loading:!1,formData:{resourceType:l.c.get("CREATE_RESOURCE_TYPE")||u.RESOURCE_TYPES.widget,resourceName:"",widgetName:"",description:"",previewImage:""},uploader:{headers:{method:"POST"}},valid:!1,meta:"{}",editMode:h,editorConfig:{},percentage:0,currentUploader:"",uploaderStates:{resource:{percentage:0,isUploaded:!1,isUploading:!1,name:""},thumbnail:{percentage:0,isUploaded:!1,isUploading:!1,name:""}}}},props:{data:{type:Object,default:function(){return{}}}},computed:{showCreatorInputItem:function(){return this.editMode===h},shouldShowResourceUploader:function(){return!(this.uploaderStates.resource.isUploading||this.uploaderStates.resource.isUploaded)},shouldShowThumbnailInput:function(){return this.formData.resourceType===u.RESOURCE_TYPES.pageBuild}},watch:{data:function(){if(this.data.resourceId&&(this.editMode=m,Object.assign(this.formData,this.data),this.formData.widgetName=this.data.systemMeta.widgetName||"",this.data.previewImages.length&&(this.formData.previewImage=this.data.previewImages[0]),this.data.meta))try{this.meta=JSON.stringify(this.data.meta)}catch(e){this.meta="{}"}}},mounted:function(){this.resourceTypeChange(this.formData.resourceType)},methods:{resourceTypeChange:function(e){l.c.set("CREATE_RESOURCE_TYPE",e)},checkMetaValid:function(e){this.valid=e},errorHandler:function(e){var t,r;if(this.loading=!1,void 0!==e.errcode)r={error:e.msg};else{switch(e.status){case 400:t="不支持的文件类型";break;case 401:t="权限未经验证";break;default:t=e.message}r={error:t}}this.$emit("uploadEnd",r),this.$refs.resourceUploader.fileList=[]},successHandler:function(e,t){this.loading=!1,0!==e.ret||0!==e.errcode?(this.$refs.resourceUploader.clearFiles(),this.uploaderStates.resource.isUploading=!1,this.uploaderStates.resource.percentage=0,this.$message.error(e.msg),this.$emit("uploadEnd",{error:e.msg})):(this.uploaderStates.resource.sha1=e.data.sha1,this.uploaderStates.resource.isUploaded=!0,this.uploaderStates.resource.percentage=100,this.autoSetFormData(t),this.$emit("uploadEnd",e.data))},autoSetFormData:function(e){var t=e.name.split(".");t.length>1&&t.pop(),t=t.join("."),this.formData.widgetName||this.formData.resourceType!==u.RESOURCE_TYPES.widget||(this.formData.widgetName=t),this.formData.resourceName||(this.formData.resourceName=t)},fileChangeHandler:function(e,t){this.fileLimitValidator(e,t)},imageUploadSuccessHandler:function(e){this.uploaderStates.thumbnail.isUploading=!1,0===e.errcode?(this.formData.previewImage=e.data,this.uploaderStates.thumbnail.isUploaded=!0,this.uploaderStates.thumbnail.percentage=100):(this.uploaderStates.thumbnail.percentage=0,this.$error.showErrorMessage(e.msg))},previewImageChangeHandler:function(e,t){this.fileLimitValidator(e,t)},validateImageHandler:function(e){return/\.(jpg|png|gif|tiff|webp)$/.test(e.name)?(this.resetUploaderState(this.uploaderStates.thumbnail),!0):(this.$message.error("不支持的图片类型"),!1)},clearUploaderHandler:function(e){var t,r=this.uploaderStates[e];(t="resource"===e?this.$refs.resourceUploader:this.$refs.thumbnailUploader).clearFiles(),t.abort(r.file),Object.assign(r,{sha1:"",name:"",isUploading:!1,isUploaded:!1,percentage:0})},beforeUploadHandler:function(e){this.resetUploaderState(this.uploaderStates.resource,e)},resetUploaderState:function(e,t){Object.assign(e,{file:t,name:t&&t.name||"",isUploading:!0,isUploaded:!1,percentage:0})},imgUploadSuccessHandler:function(e){var t=e.data,r=this.$refs.editor;0===t.errcode?r.insertImg(t.data):this.$message.error(t.msg)},validate:function(){var e=this;return new Promise(function(t,r){var a=e.uploaderStates.resource;e.$refs.createForm.validate(function(s,o){if(s){var i;if(e.editMode===h)if(a.sha1?a.isUploaded||(i="资源文件正在上传中，等上传完再点击创建"):i="未上传资源文件",i)return r(i);try{JSON.parse(e.meta)}catch(o){return console.error(o),r("meta格式有误: ".concat(o))}t()}else{var n=Object.keys(o).map(function(e){return o[e].message});r(n.join("，"))}})})},fileLimitValidator:function(e,t){return!(t.length>1)||(t.shift(),!1)},packUploadData:function(){var e,t=this.uploaderStates.resource,r={},a=this.formData,s=["resourceName"];try{e=JSON.parse(this.meta)}catch(t){e={}}this.formData.widgetName&&(e.widgetName=this.formData.widgetName),this.editMode===h?(s=s.concat(["resourceType"]),r.sha1=t.sha1,a.previewImage&&(r.previewImage=a.previewImage)):a.previewImage&&(r.previewImages=[a.previewImage]),r.meta=e;var o=this.$refs.editor.getHtml();return o&&(r.description=o),s.forEach(function(e){a[e]&&(r[e]=a[e])}),console.log(r),r},isChanged:function(){return!0},nextHandler:function(){var e=this;return new Promise(function(t,r){e.validate().then(function(){var a=e.packUploadData();e.data.resourceId?e.isChanged()?e.updateResource(a).then(t).catch(r):t():e.createResource(a).then(t).catch(r)}).catch(r)})},createResource:function(e){var t=this;return new Promise(function(r,a){t.$refs.resourceUploader.uploadFiles.length>0?t.$services.resource.post(e).then(function(e){0!==e.data.ret||0!==e.data.errcode?a(e.data.msg):r(e.data.data)}):a("无上传文件")})},updateResource:function(e){return this.$services.resource.put(this.data.resourceId,e).then(function(e){return 0!==e.data.ret||0!==e.data.errcode?Promise.reject(e):e.getData()})},uploadProgressHandler:function(e,t,r){var a,s=this.uploaderStates;s.resource.name===t.name?a=s.resource:s.thumbnail.name===t.name&&(a=s.thumbnail),a&&(a.percentage=parseInt(t.percentage.toFixed()))}}},g=(r("tDFS"),r("AVS1"),Object(n.a)(f,function(){var e=this,t=e.$createElement,r=e._self._c||t;return r("div",{staticClass:"base-resource-wrap",class:["resource-edit-mode-"+e.editMode]},[r("el-form",{ref:"createForm",attrs:{model:e.formData,"label-width":"0",rules:e.rules}},[r("el-form-item",[r("div",{staticClass:"uploader-wrapper"},[e.shouldShowThumbnailInput?r("div",{staticClass:"resource-thumbnail-input"},[r("el-upload",{directives:[{name:"show",rawName:"v-show",value:!e.uploaderStates.thumbnail.isUploading,expression:"!uploaderStates.thumbnail.isUploading"}],ref:"thumbnailUploader",staticClass:"resource-thumbnail-uploader",attrs:{drag:"",action:"/api/v1/resources/upoladPreviewImage",data:e.uploader.data,headers:e.uploader.headers,"on-error":e.errorHandler,"on-change":e.previewImageChangeHandler,"on-success":e.imageUploadSuccessHandler,"before-upload":e.validateImageHandler,"on-progress":e.uploadProgressHandler,"show-file-list":!1,"auto-upload":!0}},[e.formData.previewImage?r("img",{staticStyle:{height:"100%"},attrs:{src:e.formData.previewImage,alt:""}}):[r("i",{staticClass:"el-icon-plus"}),e._v(" "),r("div",{staticClass:"resource-file-tip"},[r("p",[e._v("资源预览图")]),e._v(" "),r("p",{staticClass:"resource-file-sub-tip"},[e._v("800X600")])])]],2),e._v(" "),r("div",{directives:[{name:"show",rawName:"v-show",value:e.uploaderStates.thumbnail.isUploading,expression:"uploaderStates.thumbnail.isUploading"}],staticClass:"thumbnail-upload-state"},[r("p",[e._v("资源预览图")]),e._v(" "),r("div",[r("i",{staticClass:"el-icon-circle-close",on:{click:function(t){e.clearUploaderHandler("thumbnail")}}}),e._v(" "),r("el-progress",{staticStyle:{"margin-right":"20px"},attrs:{"stroke-width":10,percentage:e.uploaderStates.thumbnail.percentage,color:"#333333"}})],1)])],1):e._e(),e._v(" "),r("div",{staticClass:"resource-file-input"},[r("div",{directives:[{name:"show",rawName:"v-show",value:!0===e.shouldShowResourceUploader,expression:"shouldShowResourceUploader === true"}],staticClass:"resource-file-uploader-wrap"},[e.showCreatorInputItem?r("el-upload",{ref:"resourceUploader",staticClass:"resource-file-uploader",attrs:{drag:"",action:"/api/v1/resources/uploadResourceFile",multiple:!1,data:{resourceType:e.formData.resourceType},headers:e.uploader.headers,"before-upload":e.beforeUploadHandler,"on-error":e.errorHandler,"on-change":e.fileChangeHandler,"on-success":e.successHandler,"show-file-list":!1,"on-progress":e.uploadProgressHandler,"auto-upload":!0}},[r("i",{staticClass:"el-icon-plus"}),e._v(" "),r("div",{staticClass:"resource-file-tip"},[r("p",[e._v("资源文件")]),e._v(" "),r("p",{staticClass:"resource-file-sub-tip"},[e._v("拖拽或点击上传，最大不超过50M")])])]):e._e(),e._v(" "),e.uploaderStates.resource.isUploading?e._e():r("el-select",{staticClass:"resource-type",attrs:{disabled:!e.showCreatorInputItem,"allow-create":"",filterable:"",placeholder:"资源类型"},on:{change:e.resourceTypeChange},model:{value:e.formData.resourceType,callback:function(t){e.$set(e.formData,"resourceType",t)},expression:"formData.resourceType"}},e._l(e.options,function(e){return r("el-option",{key:e.value,attrs:{label:e.label,value:e.value}})}))],1),e._v(" "),r("div",{directives:[{name:"show",rawName:"v-show",value:!1===e.shouldShowResourceUploader,expression:"shouldShowResourceUploader === false"}],staticClass:"resource-upload-state"},[r("div",{staticClass:"resource-type-desc"},[e._v("资源文件类型："+e._s(e.formData.resourceType))]),e._v(" "),r("div",[r("i",{staticClass:"el-icon-circle-close",on:{click:function(t){e.clearUploaderHandler("resource")}}}),e._v(" "),e.shouldShowResourceUploader?e._e():r("el-progress",{staticClass:"resource-file-progress",attrs:{"stroke-width":10,percentage:e.uploaderStates.resource.percentage,color:"#333333"}})],1)])])])]),e._v(" "),r("el-form-item",{attrs:{prop:"resourceName"}},[r("input",{directives:[{name:"model",rawName:"v-model",value:e.formData.resourceName,expression:"formData.resourceName"}],staticClass:"input-item resource-name",attrs:{type:"text",placeholder:"资源标题"},domProps:{value:e.formData.resourceName},on:{input:function(t){t.target.composing||e.$set(e.formData,"resourceName",t.target.value)}}})]),e._v(" "),r("el-form-item",{directives:[{name:"show",rawName:"v-show",value:e.formData.resourceType===e.ResourceTypes.widget,expression:"formData.resourceType === ResourceTypes.widget"}],attrs:{prop:"widgetName"}},[r("input",{directives:[{name:"model",rawName:"v-model",value:e.formData.widgetName,expression:"formData.widgetName"}],staticClass:"input-item widget-name",attrs:{type:"text",disabled:!e.showCreatorInputItem,placeholder:"widget名称"},domProps:{value:e.formData.widgetName},on:{input:function(t){t.target.composing||e.$set(e.formData,"widgetName",t.target.value)}}})]),e._v(" "),r("el-form-item",{attrs:{prop:"description"}},[r("rich-editor",{ref:"editor",staticClass:"res-desc-editor",attrs:{width:"100%",config:e.editorConfig,placeholder:"请输入资源描述"},on:{load:e.imgUploadSuccessHandler},model:{value:e.formData.description,callback:function(t){e.$set(e.formData,"description",t)},expression:"formData.description"}})],1),e._v(" "),r("el-form-item",[r("h4",{staticClass:"step-title"},[e._v("资源meta信息")]),e._v(" "),r("resource-meta-info",{attrs:{placeholder:"资源meta信息"},on:{validate:e.checkMetaValid},model:{value:e.meta,callback:function(t){e.meta=t},expression:"meta"}})],1)],1)],1)},[],!1,null,"0043d261",null));t.a=g.exports},tDFS:function(e,t,r){"use strict";var a=r("MiEe");r.n(a).a}}]);