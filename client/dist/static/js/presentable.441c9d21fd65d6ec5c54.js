(window.webpackJsonp=window.webpackJsonp||[]).push([["presentable"],{"4AHe":function(e,t,r){},"5z/q":function(e,t,r){},Fq1f:function(e,t,r){"use strict";var a=r("d6so");r.n(a).a},IP6f:function(e,t,r){"use strict";var a=r("3eXy");r("snnE");function s(e){return a.PresentablesService.get(e).then(function(e){return e.getData()})}var n=s;t.a={loadDetail:s,onloadPresentableDetail:n}},LxJW:function(e,t,r){"use strict";var a=r("5z/q");r.n(a).a},d6so:function(e,t,r){},eDHJ:function(e,t,r){"use strict";r.r(t);var a=r("8SHQ"),s=r("NKFe"),n=r.n(s),c=r("ESlw"),o=r("b4GV"),i=r("rfs2"),l={name:"presentable-creator",data:function(){return{selectedIndex:!1}},props:{formData:Object},mounted:function(){},components:{FreelogTags:c.a,PresentableEditor:i.a,PresentablePolicy:o.a},methods:{segmentChangeHandler:function(e,t){void 0!==t&&(this.selectedIndex=t),e.selectedPolicy=e.data.policy[this.selectedIndex]||!1}}},u=(r("Fq1f"),r("KHd+")),d=Object(u.a)(l,function(){var e=this,t=e.$createElement,r=e._self._c||t;return e.formData.data?r("div",{staticClass:"create-form-wrap"},[r("div",{staticClass:"step-1 op-step",attrs:{id:"js-form-step-1"}},[e._m(0),e._v(" "),r("el-table",{staticClass:"step-body contract-select-wrap",attrs:{data:e.formData.data.policy}},[r("el-table-column",{attrs:{type:"expand"},scopedSlots:e._u([{key:"default",fn:function(t){return[r("pre",[e._v(e._s(t.row._formatSegmentText))])]}}])}),e._v(" "),r("el-table-column",{attrs:{label:"segmentId",prop:"segmentId"}}),e._v(" "),r("el-table-column",{attrs:{label:"目标用户"},scopedSlots:e._u([{key:"default",fn:function(t){return e._l(t.row.forUsers,function(t,a){return r("el-tag",{key:a,attrs:{type:"individual"===t.type?"":"warning"}},[e._v("\n            "+e._s(t.users)+"\n          ")])})}}])}),e._v(" "),r("el-table-column",{attrs:{width:"100",label:"操作"},scopedSlots:e._u([{key:"default",fn:function(t){return[r("el-radio",{attrs:{label:t.$index},on:{change:function(t){e.segmentChangeHandler(e.formData)}},model:{value:e.selectedIndex,callback:function(t){e.selectedIndex=t},expression:"selectedIndex"}},[r("span",{attrs:{title:"placeholder"}})]),e._v(" "),r("el-tooltip",{directives:[{name:"show",rawName:"v-show",value:t.row.created,expression:"props.row.created"}],staticClass:"item",attrs:{effect:"dark",content:"该策略已经创建过合同",placement:"top"}},[r("i",{staticClass:"el-icon-info"})]),e._v(" "),r("el-tooltip",{directives:[{name:"show",rawName:"v-show",value:e.selectedIndex===t.$index,expression:"selectedIndex===props.$index"}],staticClass:"item",attrs:{effect:"dark",content:"取消选择",placement:"top"}},[r("i",{staticClass:"el-icon-circle-close-outline",on:{click:function(t){e.segmentChangeHandler(e.formData,!1)}}})])]}}])})],1)],1),e._v(" "),r("div",{staticClass:"step-2 op-step"},[e._m(1),e._v(" "),r("presentable-editor",{attrs:{data:e.formData.presentableInput}})],1),e._v(" "),e.formData.widgets&&e.formData.widgets.length>0?r("div",{staticClass:"step-3 op-step"},[e._m(2),e._v(" "),r("div",{staticClass:"step-body"},[r("el-alert",{attrs:{title:"该资源依赖以下资源，创建好page build后，需签约以下资源page build方可使用",type:"warning",closable:!1,"show-icon":""}}),e._v(" "),r("ul",{staticClass:"dep-widget-list"},e._l(e.formData.widgets,function(t){return r("li",{staticClass:"widget-detail-link"},[r("a",{attrs:{href:t.detailUrl,target:"_blank"}},[r("el-tag",{attrs:{type:"warning"}},[e._v(e._s(t.resourceId))])],1)])}))],1)]):e._e()]):e._e()},[function(){var e=this.$createElement,t=this._self._c||e;return t("div",{staticClass:"step-header"},[t("div",{staticClass:"step-circle"},[this._v("1")]),this._v(" "),t("div",{staticClass:"step-title"},[this._v("选择合同策略"),t("span",{staticStyle:{color:"#f56c6c","margin-left":"3px"}},[this._v("*")])])])},function(){var e=this.$createElement,t=this._self._c||e;return t("div",{staticClass:"step-header"},[t("div",{staticClass:"step-circle"},[this._v("2")]),this._v(" "),t("div",{staticClass:"step-title"},[this._v("创建用户消费策略")])])},function(){var e=this.$createElement,t=this._self._c||e;return t("div",{staticClass:"step-header"},[t("div",{staticClass:"step-circle"},[this._v("3")]),this._v(" "),t("div",{staticClass:"step-title"},[this._v("创建pagebuild presentable补充说明")])])}],!1,null,"52b28a5a",null).exports;function f(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){var r=[],a=!0,s=!1,n=void 0;try{for(var c,o=e[Symbol.iterator]();!(a=(c=o.next()).done)&&(r.push(c.value),!t||r.length!==t);a=!0);}catch(e){s=!0,n=e}finally{try{a||null==o.return||o.return()}finally{if(s)throw n}}return r}(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}()}var p=a.a.RESOURCE_TYPES,h={name:"node-presentable-creator",data:function(){return{formData:{}}},mounted:function(){this.$route.query.resourceId?this.init():this.$message.error("没有资源Id, 请重新选择")},components:{PresentableCreator:d},computed:{canSubmit:function(){return!!this.formData.selectedPolicy}},methods:{init:function(){var e=this;this.loadPolicyDetail().then(this.queryContractsStatus.bind(this)).then(function(t){e.formData=t,console.log(e.formData.data.policy)}).catch(this.$error.showErrorMessage)},queryContractsStatus:function(e){var t=this.$route.params.nodeId;return this.$services.contractRecords.get({params:{contractType:2,resourceIds:e.resource.resourceId,partyTwo:t}}).then(function(t){return t.getData().forEach(function(t){if(e.resource.resourceId===t.resourceId){var r=e.data.policy,a=!0,s=!1,n=void 0;try{for(var c,o=r.entries()[Symbol.iterator]();!(a=(c=o.next()).done);a=!0){var i=f(c.value,2),l=(i[0],i[1]);if(l.segmentId===t.segmentId){l.created=!0;break}}}catch(e){s=!0,n=e}finally{try{a||null==o.return||o.return()}finally{if(s)throw n}}}}),e})},loadResourceDetail:function(e){return this.$services.resource.get(e).then(function(e){return e.getData()})},loadPolicyDetail:function(){var e=this,t=this.$route.query;return new Promise(function(r){r(e.loadResourceDetail(t.resourceId))}).then(function(t){var r={resource:t,data:{},presentableInput:{name:t.resourceName,policyText:"",userDefinedTags:[]},selectedPolicy:null};return r.widgets=t&&t.systemMeta&&t.systemMeta.widgets||[],r.widgets=r.widgets.map(function(e){return e.detailUrl="/resources/detail/".concat(e.resourceId),e}),e.$services.policy.get(t.resourceId).then(function(t){var a=t.getData();return a.policy.forEach(function(t){t.created=!1,t._formatSegmentText=e.formatSegmentText(t.segmentText),t.forUsers=t.users.map(function(e){return{type:e.userType,users:e.users.join(",")}})}),Object.assign(r.data,a),r})})},formatSegmentText:function(e){return n.a.beautify(e)},createResourceContract:function(e){return this.$services.contract.post(e).then(function(e){var t=e.getData();if(0!==e.data.errcode)throw new Error(e.data.msg);return t})},createPresentablePolicy:function(e){return this.$services.presentables.post(e).then(function(e){if(0===e.data.errcode)return e.getData();throw new Error(e.data.msg)})},extractSubmitData:function(){var e=parseInt(this.$route.params.nodeId),t=this.formData;return{contract:{contractType:"2",targetId:t.resource.resourceId,segmentId:t.selectedPolicy.segmentId,partyTwo:e},policy:{nodeId:e,name:t.presentableInput.name,resourceId:t.resource.resourceId,policyText:btoa(t.presentableInput.policyText),languageType:"freelog_policy_lang",userDefinedTags:t.presentableInput.userDefinedTags.join(",")}}},gotoPresentablDetail:function(e){var t=parseInt(this.$route.params.nodeId),r=this.$route.query.pbPresentableId,a=!!r;a||(a=(this.formData.resource.resourceType||e.tagInfo.resourceInfo.resourceType)===p.pageBuild);var s={ispb:a};e.presentableId?s.presentableId=e.presentableId:e.contractId&&(s.contractId=e.contractId);var n=r?{path:"/node/".concat(t,"/presentable/detail"),query:{presentableId:r,ispb:!0}}:{path:"/node/".concat(t,"/presentable/detail#presentable"),query:s};this.$router.push(n)},submit:function(){var e=this;if(!this.canSubmit)return document.body.scrollIntoView("#js-form-step-1"),this.$message.warning("未选择合同策略");var t=this.extractSubmitData();this.createResourceContract(t.contract).then(function(e){t.policy.contractId=e.contractId}).then(function(){if(t.policy.name&&t.policy.policyText)return e.createPresentablePolicy(t.policy)}).then(function(r){e.$message.success("presentable创建成功"),r?e.gotoPresentablDetail(r):e.gotoPresentablDetail(t.policy)}).catch(function(r){e.$error.showErrorMessage(r),e.gotoPresentablDetail(t.policy)})}}},m=(r("xdK5"),Object(u.a)(h,function(){var e=this,t=e.$createElement,r=e._self._c||t;return r("section",[e.formData.resource?r("h3",{staticStyle:{"margin-bottom":"20px"}},[e._v("> "+e._s(e.formData.resource.resourceName))]):e._e(),e._v(" "),r("presentable-creator",{attrs:{formData:e.formData},on:{"update:formData":function(t){e.formData=t}}}),e._v(" "),r("div",{staticClass:"form-ft"},[r("el-button",{on:{click:e.submit}},[e._v("提交")])],1)],1)},[],!1,null,"70e1f8ac",null));t.default=m.exports},iwFP:function(e,t,r){"use strict";var a=r("4AHe");r.n(a).a},wmkz:function(e,t,r){"use strict";r.r(t);var a=r("7+cO"),s=r("IP6f"),n=r("aNms"),c=r("59r6"),o=r("qTA6"),i={name:"presentable-scheme-detail",components:{ResourceSchemeTree:a.a,ResourceIntroInfo:o.a},data:function(){return{isInitStatus:!1,params:this.$route.params,presentableDetail:{contracts:[],schemes:[],resourceInfo:{}},cachedContractsMap:{}}},mounted:function(){this.initView(this.params)},computed:{},watch:{},methods:{initView:function(e){var t=this;e.presentableId&&s.a.onloadPresentableDetail(e.presentableId).then(function(e){e&&e.contracts&&(t.isInitStatus=!e.contracts.length,e.contracts.slice(0).reduce(function(e,r){return e[t.getSchemeContractKey(r)]=r,e},t.cachedContractsMap),c.a.onloadResourceDetail(e.resourceId).then(function(r){console.log("detail",r),Object.assign(e.resourceInfo,r),e.resourceInfo.contracts=e.contracts,t.presentableDetail=e}))})},loadPresentableSchemes:function(e){var t=this;n.a.onloadSchemesForResource(e).then(function(e){console.log(e),t.presentableDetail.schemes=e})},getSchemeContractKey:function(e){return"".concat(e.authSchemeId,"_").concat(e.policySegmentId)},saveSchemeHandler:function(){var e,t=this,r=this.$refs.schemeTree.getDutyStatements(),a={},s=this.presentableDetail.resourceId,n=this.cachedContractsMap,c=[];r.map(function(e){var r=e.selectedScheme;if(r){a[e.resourceId]=r.authSchemeId;var s=r.selectedPolicy.segmentId,o={resourceId:e.resourceId},i={authSchemeId:r.authSchemeId,policySegmentId:s},l=t.getSchemeContractKey(i);n[l]?o.contractId=n[l].contractId:Object.assign(o,i),c.push(o)}else a[e.resourceId]=e.authSchemeId});for(var o=0;o<r.length;o++)if(r[o].resourceId===s){e=r[o];break}e?2===e.activeStatus?this.updatePresentableSchemes({contracts:c}):this.$message.error("有资源未选择授权策略"):(console.log("error contracts",c),this.$message.error("未选择授权方案"))},updatePresentableSchemes:function(e){var t=this;return this.$services.presentables.put(this.params.presentableId,e).then(function(e){0===e.data.errcode?(t.isInitStatus=!e.data.data.contracts.length,t.$message.success("更新成功"),t.gotoContractView(e.data.data)):t.$error.showErrorMessage(e)})},gotoContractView:function(e){for(var t={tab:"node-contracts"},r=0;r<e.contracts.length;r++){var a=e.contracts[r];if(a.resourceId===this.presentableDetail.resourceId){t.contractId=a.contractId;break}}this.$router.push({path:"/node/".concat(this.params.nodeId),query:t})},switchSchemeHandler:function(e,t,r,a){},selectResourceHandler:function(e,t,r,a){},changePolicy:function(e,t,r){},changeSchemePolicyHandler:function(e,t){},selectAuthSchemeHandler:function(e,t,r){}}},l=(r("iwFP"),r("LxJW"),r("KHd+")),u=Object(l.a)(i,function(){var e=this.$createElement,t=this._self._c||e;return t("div",{staticClass:"presentable-auth-scheme-wrap"},[t("resource-scheme-tree",{ref:"schemeTree",staticClass:"presentable-auth-scheme-tree",attrs:{contracts:this.presentableDetail.resourceInfo.contracts,resource:this.presentableDetail.resourceInfo}}),this._v(" "),t("div",{staticClass:"ft clearfix"},[t("div",{staticClass:"rt-side"},[t("el-button",{staticClass:"ft-btn deep-color-btn",attrs:{type:"primary",round:""},on:{click:this.saveSchemeHandler}},[this._v("\n        "+this._s(this.isInitStatus?"生成合约":"更新合约")+"\n      ")])],1)])],1)},[],!1,null,"2cfc91d5",null);t.default=u.exports},xdK5:function(e,t,r){"use strict";var a=r("zv/P");r.n(a).a},"zv/P":function(e,t,r){}}]);